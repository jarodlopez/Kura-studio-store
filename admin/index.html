<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KURA | ENTERPRISE ADMIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- LIBRER√çAS PARA PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --neon-red: #ff003c; --acid-green: #ccff00; --cyber-black: #050505; --dark-gray: #111; }
        body { font-family: 'Chakra Petch', sans-serif; background-color: var(--cyber-black); color: #e5e5e5; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .cyber-input { background: var(--dark-gray); border: 1px solid #333; color: white; font-family: 'JetBrains Mono', monospace; transition: all 0.2s; }
        .cyber-input:focus { border-color: var(--acid-green); outline: none; }
        .cyber-btn { clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); transition: all 0.2s; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }
        .cyber-btn:hover { transform: translateY(-2px); filter: brightness(1.2); }
        .cyber-card { border: 1px solid #222; background: #0a0a0a; position: relative; }
        .cyber-card:hover { border-color: var(--neon-red); }
        .toggle-checkbox:checked { right: 0; border-color: var(--acid-green); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--acid-green); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #000; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        #login-overlay { background-image: radial-gradient(circle at center, #111 0%, #000 100%); }
        
        /* Animaci√≥n POS */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row md:overflow-hidden relative bg-black">

    <!-- LOGIN SCREEN -->
    <div id="login-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-4 overflow-y-auto">
        <div class="w-full max-w-md bg-[#0a0a0a] border border-[#333] p-8 shadow-[0_0_50px_rgba(0,0,0,0.8)] relative overflow-hidden my-auto flex flex-col items-center">
            <img id="loginLogo" src="" class="w-24 h-24 object-cover rounded-full border-2 border-[#ff003c] mb-6 hidden">
            <h1 class="text-3xl font-black italic tracking-tighter text-white mb-2">KURA<span class="text-[#ff003c]">ADMIN</span></h1>
            <p class="text-[10px] font-mono text-neutral-500 mb-6">ACCESO RESTRINGIDO // STAFF ONLY</p>
            <form id="loginForm" class="space-y-4 w-full">
                <input type="email" id="email" class="cyber-input w-full p-3 text-sm" placeholder="admin@kurastudio.com" required>
                <input type="password" id="password" class="cyber-input w-full p-3 text-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                <div id="loginError" class="text-red-500 text-xs font-mono hidden"></div>
                <button type="submit" id="loginBtn" class="cyber-btn w-full bg-[#ff003c] text-white py-3 mt-4 flex items-center justify-center gap-2"><i data-lucide="lock"></i> INICIAR SESI√ìN</button>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-full md:w-64 bg-[#0a0a0a] border-r border-[#222] flex flex-col z-20 shrink-0">
        <div class="p-6 border-b border-[#222]">
            <h1 class="text-2xl font-black italic tracking-tighter text-white">KURA<span class="text-[#ff003c]">OS</span></h1>
            <p class="text-[10px] text-neutral-500 font-mono mt-1">STOCK & POS SYSTEM V6.2</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('products')" id="tab-products" class="nav-btn w-full text-left p-3 bg-[#111] text-[#ccff00] border-l-2 border-[#ccff00] flex items-center gap-3 font-bold transition-all"><i data-lucide="package"></i> INVENTARIO</button>
            <button onclick="switchTab('pos')" id="tab-pos" class="nav-btn w-full text-left p-3 hover:bg-[#111] text-neutral-400 border-l-2 border-transparent hover:border-white flex items-center gap-3 transition-all"><i data-lucide="monitor"></i> P.O.S (VENTA)</button>
            <button onclick="switchTab('orders')" id="tab-orders" class="nav-btn w-full text-left p-3 hover:bg-[#111] text-neutral-400 border-l-2 border-transparent hover:border-white flex items-center gap-3 transition-all"><i data-lucide="shopping-cart"></i> √ìRDENES</button>
            <button onclick="switchTab('landing')" id="tab-landing" class="nav-btn w-full text-left p-3 hover:bg-[#111] text-neutral-400 border-l-2 border-transparent hover:border-white flex items-center gap-3 transition-all"><i data-lucide="layout-template"></i> PORTADA</button>
        </nav>
        <div class="p-4 border-t border-[#222]"><button onclick="logout()" class="w-full text-left text-xs font-mono text-red-500 hover:text-white flex items-center gap-2"><i data-lucide="log-out" width="14"></i> SALIR</button></div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 bg-black relative md:overflow-y-auto md:h-screen h-auto custom-scrollbar">
        
        <!-- VISTA PRODUCTOS -->
        <div id="view-products" class="p-6 md:p-10 space-y-6 pb-24">
            <div class="flex justify-between items-center sticky top-0 bg-black/90 backdrop-blur z-10 py-4 border-b border-[#222]">
                <h2 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="box"></i> INVENTARIO & STOCK</h2>
                <button onclick="openModal()" class="cyber-btn bg-[#ccff00] text-black px-6 py-3 flex items-center gap-2"><i data-lucide="plus"></i> NUEVO ITEM</button>
            </div>
            <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </div>

        <!-- VISTA POS (POINT OF SALE) MEJORADA -->
        <div id="view-pos" class="hidden p-4 md:p-6 pb-24 h-full flex flex-col md:flex-row gap-6">
            <div class="flex-1 flex flex-col h-full">
                <div class="mb-4 sticky top-0 bg-black z-10 py-2"><input type="text" id="posSearch" placeholder="Escanear o Buscar producto..." class="cyber-input w-full p-4 text-lg" onkeyup="filterPos()" autofocus></div>
                <div id="posGrid" class="grid grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto custom-scrollbar pb-20"></div>
            </div>
            <!-- PANEL DERECHO (CAJA) -->
            <div class="w-full md:w-[400px] bg-[#0a0a0a] border border-[#222] flex flex-col h-[calc(100vh-100px)] sticky top-4 shadow-2xl">
                <div class="p-4 border-b border-[#222] bg-[#111] flex justify-between items-center">
                    <h3 class="font-bold text-[#ccff00] flex items-center gap-2"><i data-lucide="shopping-bag"></i> CAJA REGISTRADORA</h3>
                    <button onclick="clearPosCart()" class="text-xs text-red-500 hover:text-white flex items-center gap-1"><i data-lucide="trash-2" width="12"></i> VACIAR</button>
                </div>
                
                <!-- DATOS DEL CLIENTE POS -->
                <div class="p-4 border-b border-[#333] space-y-2 bg-[#050505]">
                    <div class="flex gap-2">
                        <input id="posClientName" class="cyber-input w-full p-2 text-xs" placeholder="Consumidor Final">
                        <input id="posClientPhone" class="cyber-input w-1/3 p-2 text-xs" placeholder="Tel√©fono">
                    </div>
                </div>

                <div id="posCart" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-black/50">
                    <div class="text-center text-gray-600 text-xs mt-10 italic">Carrito Vac√≠o</div>
                </div>
                
                <div class="p-6 border-t border-[#222] bg-[#111] space-y-4">
                    <div class="flex justify-between text-2xl font-black text-white font-mono"><span>TOTAL</span><span id="posTotal">C$ 0.00</span></div>
                    <button onclick="openPaymentModal()" class="cyber-btn w-full bg-[#ff003c] text-white py-4 text-xl shadow-[0_0_20px_rgba(255,0,60,0.4)] hover:shadow-[0_0_30px_rgba(255,0,60,0.6)] flex justify-center items-center gap-3">
                        <i data-lucide="credit-card"></i> COBRAR
                    </button>
                </div>
            </div>
        </div>

        <!-- VISTA √ìRDENES -->
        <div id="view-orders" class="hidden p-6 md:p-10 space-y-6 pb-24">
            <h2 class="text-xl font-bold text-white flex items-center gap-2 sticky top-0 bg-black py-4 z-10"><i data-lucide="list-ordered"></i> HISTORIAL DE √ìRDENES</h2>
            <div class="overflow-x-auto border border-[#222] bg-[#0a0a0a]">
                <table class="w-full text-left text-sm">
                    <thead class="bg-[#111] text-neutral-400 font-mono text-xs uppercase"><tr><th class="p-4">ID</th><th class="p-4">Fecha</th><th class="p-4">Cliente</th><th class="p-4">Total</th><th class="p-4">Pago</th><th class="p-4">Status</th><th class="p-4">Acci√≥n</th></tr></thead>
                    <tbody id="ordersTableBody" class="divide-y divide-[#222] text-neutral-300"></tbody>
                </table>
            </div>
        </div>

        <!-- VISTA LANDING -->
        <div id="view-landing" class="hidden p-6 md:p-10 space-y-6 pb-24">
            <div class="flex justify-between items-center sticky top-0 bg-black/90 backdrop-blur z-10 py-4 border-b border-[#222]">
                <h2 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="layout-template"></i> CONFIGURACI√ìN</h2>
                <button onclick="saveLandingConfig()" id="btnSaveLanding" class="cyber-btn bg-[#ff003c] text-white px-6 py-3 flex items-center gap-2"><i data-lucide="save"></i> GUARDAR</button>
            </div>
            <div class="max-w-4xl mx-auto space-y-8">
                <!-- Configuraci√≥n simplificada -->
                <div class="bg-[#0a0a0a] border border-[#222] p-6 space-y-4">
                     <h3 class="text-[#ccff00] font-bold border-b border-[#333] pb-2">APARIENCIA</h3>
                     <div class="grid md:grid-cols-2 gap-4">
                         <div><label class="text-[10px] text-gray-500">T√çTULO</label><input id="landingTitle" class="cyber-input w-full p-2"></div>
                         <div><label class="text-[10px] text-gray-500">SUBT√çTULO</label><input id="landingSubtitle" class="cyber-input w-full p-2"></div>
                         <div><label class="text-[10px] text-gray-500">LOGO URL</label><input id="landingLogo" class="cyber-input w-full p-2"></div>
                         <div><label class="text-[10px] text-gray-500">FONDO URL</label><input id="landingBgImage" class="cyber-input w-full p-2"></div>
                     </div>
                     <h3 class="text-[#ccff00] font-bold border-b border-[#333] pb-2 pt-4">REDES & LINKS</h3>
                     <div class="grid md:grid-cols-2 gap-4">
                         <div><label class="text-[10px] text-gray-500">INSTAGRAM</label><input id="landingInsta" class="cyber-input w-full p-2"></div>
                         <div><label class="text-[10px] text-gray-500">WHATSAPP</label><input id="landingWhatsapp" class="cyber-input w-full p-2" placeholder="https://wa.me/..."></div>
                         <div><label class="text-[10px] text-gray-500">TIKTOK</label><input id="landingTiktok" class="cyber-input w-full p-2"></div>
                         <div><label class="text-[10px] text-gray-500">TEXTO BOT√ìN</label><input id="landingBtnText" class="cyber-input w-full p-2"></div>
                     </div>
                     <h3 class="text-[#ccff00] font-bold border-b border-[#333] pb-2 pt-4">CONEXI√ìN</h3>
                     <div>
                         <label class="text-[10px] text-gray-500 font-bold">URL DE LA TIENDA (Al dar clic en "Entrar" ir√° aqu√≠)</label>
                         <input id="landingStoreUrl" class="cyber-input w-full p-2 text-[#ccff00]" placeholder="ej: https://mitienda.com">
                     </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL PRODUCTO -->
    <div id="productModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="absolute top-0 right-0 h-full w-full md:w-[500px] bg-[#0f0f0f] border-l border-[#222] shadow-2xl transform transition-transform duration-300 translate-x-full flex flex-col" id="modalContent">
            <div class="p-6 border-b border-[#222] flex justify-between items-center bg-[#111]"><h3 id="modalTitle" class="text-lg font-bold text-white uppercase">PRODUCTO</h3><button onclick="closeModal()" class="text-neutral-500 hover:text-white"><i data-lucide="x"></i></button></div>
            <form id="productForm" class="flex-1 overflow-y-auto p-6 space-y-5 custom-scrollbar">
                <input type="hidden" id="editId"><input type="hidden" id="currentImageUrl">
                <div class="flex items-center justify-between bg-[#050505] p-3 border border-[#222]"><span class="text-xs font-bold uppercase text-white">Visible en Tienda</span><input type="checkbox" id="isActive" class="accent-[#ccff00] w-5 h-5"></div>
                
                <div><label class="text-xs text-gray-500">NOMBRE</label><input type="text" id="name" required class="cyber-input w-full p-3 text-sm"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-gray-500">PRECIO (C$)</label><input type="number" id="price" required class="cyber-input w-full p-3 text-sm"></div>
                    <div><label class="text-xs text-[#ff003c]">PRECIO ANTERIOR</label><input type="number" id="comparePrice" class="cyber-input w-full p-3 text-sm border-[#ff003c]/30"></div>
                </div>
                <div><label class="text-xs text-gray-500">CATEGOR√çA</label><select id="category" class="cyber-input w-full p-3 text-sm uppercase"><option>TOPS</option><option>BOTTOMS</option><option>OUTERWEAR</option><option>ACCESSORIES</option></select></div>
                
                <!-- CONTROL DE STOCK -->
                <div class="bg-[#0a0a0a] border border-[#333] p-3">
                    <label class="text-xs font-bold text-[#ccff00] mb-2 block">VARIANTES & STOCK</label>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="newVariantSize" placeholder="Talla (Ej: M)" class="cyber-input w-1/2 p-2 text-xs uppercase">
                        <input type="number" id="newVariantQty" placeholder="Cant" class="cyber-input w-1/4 p-2 text-xs">
                        <button type="button" onclick="addVariant()" class="bg-[#333] text-white px-3 hover:bg-[#ccff00] hover:text-black"><i data-lucide="plus" width="14"></i></button>
                    </div>
                    <div id="variantsList" class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar"></div>
                    <input type="hidden" id="variantsData" value="{}">
                </div>

                <div><label class="text-xs text-gray-500">DESCRIPCI√ìN</label><textarea id="description" rows="3" class="cyber-input w-full p-3 text-sm"></textarea></div>
                <div><label class="text-xs text-gray-500">IMAGEN</label><input type="file" id="imageFile" accept="image/*" class="cyber-input w-full p-2 text-xs" onchange="previewFile()"><img id="imgPreview" src="" class="mt-2 h-32 object-contain hidden border border-[#333]"></div>
            </form>
            <div class="p-6 border-t border-[#222] bg-[#0a0a0a]"><button form="productForm" id="saveBtn" class="cyber-btn w-full bg-[#ff003c] text-white py-4 flex items-center justify-center gap-2">GUARDAR DATOS</button></div>
        </div>
    </div>

    <!-- MODAL SELECCI√ìN VARIANTE POS -->
    <div id="posVariantModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closePosVariantModal()"></div>
        <div class="bg-[#111] border border-[#333] w-full max-w-sm relative z-10 p-6 shadow-2xl flex flex-col">
            <h3 class="text-[#ccff00] font-mono text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="layers"></i> SELECCIONAR VARIANTE</h3>
            <p id="posVariantProductName" class="text-white mb-4 text-sm border-b border-[#333] pb-2"></p>
            <div id="posVariantOptions" class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto custom-scrollbar"></div>
            <button onclick="closePosVariantModal()" class="mt-6 w-full text-center text-gray-500 hover:text-white text-xs font-mono">CANCELAR</button>
        </div>
    </div>

    <!-- MODAL COBRO (CHECKOUT POS) - NUEVO -->
    <div id="posPaymentModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-sm" onclick="closePaymentModal()"></div>
        <div class="bg-[#111] border border-[#333] w-full max-w-md relative z-10 p-8 shadow-[0_0_50px_rgba(204,255,0,0.2)] flex flex-col animate-slide-up">
            <h3 class="text-2xl font-black text-white text-center mb-6">CONFIRMAR PAGO</h3>
            
            <div class="space-y-4 mb-6">
                <div class="flex justify-between text-neutral-400 text-sm"><span>Cliente:</span><span id="confClient" class="text-white font-bold"></span></div>
                <div class="flex justify-between text-neutral-400 text-sm"><span>Items:</span><span id="confItems" class="text-white font-bold"></span></div>
                <div class="flex justify-between text-3xl font-black text-[#ccff00] border-t border-b border-[#333] py-4"><span>TOTAL:</span><span id="confTotal"></span></div>
            </div>

            <label class="text-[10px] text-gray-500 uppercase font-bold mb-2">M√âTODO DE PAGO</label>
            <div class="grid grid-cols-2 gap-2 mb-6">
                <button onclick="selectPayment('Efectivo')" class="pay-opt p-3 border border-[#333] text-sm hover:border-[#ccff00] hover:bg-[#222] text-white focus:bg-[#ccff00] focus:text-black font-bold">üíµ EFECTIVO</button>
                <button onclick="selectPayment('Tarjeta')" class="pay-opt p-3 border border-[#333] text-sm hover:border-[#ccff00] hover:bg-[#222] text-white focus:bg-[#ccff00] focus:text-black font-bold">üí≥ TARJETA</button>
                <button onclick="selectPayment('Transferencia')" class="pay-opt p-3 border border-[#333] text-sm hover:border-[#ccff00] hover:bg-[#222] text-white focus:bg-[#ccff00] focus:text-black font-bold">üè¶ TRANSF</button>
                <button onclick="selectPayment('Link')" class="pay-opt p-3 border border-[#333] text-sm hover:border-[#ccff00] hover:bg-[#222] text-white focus:bg-[#ccff00] focus:text-black font-bold">üîó LINK</button>
            </div>
            <input type="hidden" id="selectedPaymentMethod" value="Efectivo">

            <button onclick="confirmPosSale()" id="btnProcessPayment" class="cyber-btn w-full bg-[#ccff00] text-black py-4 font-bold text-xl hover:bg-white transition-colors">PROCESAR VENTA</button>
            <button onclick="closePaymentModal()" class="mt-4 text-xs text-neutral-500 hover:text-white text-center">CANCELAR</button>
        </div>
    </div>

    <!-- MODAL EXITO (RECIBO) - NUEVO -->
    <div id="posSuccessModal" class="fixed inset-0 z-[90] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-[#050505] z-0"></div> <!-- Full screen black -->
        <div class="relative z-10 flex flex-col items-center justify-center w-full max-w-lg text-center p-6 animate-slide-up">
            <div class="w-20 h-20 rounded-full bg-[#ccff00] flex items-center justify-center mb-6 text-black shadow-[0_0_30px_#ccff00]">
                <i data-lucide="check" width="40" height="40"></i>
            </div>
            <h2 class="text-4xl font-black text-white mb-2">¬°VENTA EXITOSA!</h2>
            <p class="text-neutral-400 mb-8 font-mono">ORDEN <span id="successOrderId" class="text-[#ccff00]"></span></p>
            
            <div class="grid gap-4 w-full">
                <button onclick="downloadLastInvoice()" class="cyber-btn bg-white text-black py-4 flex items-center justify-center gap-2 hover:bg-gray-200">
                    <i data-lucide="printer"></i> IMPRIMIR FACTURA
                </button>
                <button onclick="sendLastWhatsapp()" class="cyber-btn bg-[#25D366] text-black py-4 flex items-center justify-center gap-2 hover:bg-[#128C7E]">
                    <i data-lucide="message-circle"></i> ENVIAR A WHATSAPP
                </button>
                <button onclick="resetPos()" class="text-neutral-500 hover:text-white mt-4 py-4 border border-[#333] hover:border-white">
                    <i data-lucide="refresh-cw" class="inline w-4 h-4 mr-2"></i> NUEVA VENTA
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DETALLE ORDEN (HISTORIAL) -->
    <div id="orderModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeOrderModal()"></div>
        <div class="bg-[#111] border border-[#333] w-full max-w-lg relative z-10 p-0 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-[#333] flex justify-between items-center bg-[#0a0a0a]">
                <h3 class="text-[#ccff00] font-mono text-lg font-bold">ORDEN #<span id="modalOrderId"></span></h3>
                <button onclick="closeOrderModal()" class="text-white hover:text-red-500"><i data-lucide="x"></i></button>
            </div>
            <div id="orderDetailContent" class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-4 text-sm text-neutral-300"></div>
            <div class="p-4 border-t border-[#333] bg-[#0a0a0a] space-y-3">
                <div class="flex gap-2">
                    <button id="btnDownloadInvoice" class="flex-1 bg-white text-black py-2 font-bold text-xs hover:bg-gray-200 flex items-center justify-center gap-2"><i data-lucide="printer"></i> IMPRIMIR FACTURA</button>
                    <button id="btnSendWhatsapp" class="flex-1 bg-[#25D366] text-black py-2 font-bold text-xs hover:bg-[#128C7E] flex items-center justify-center gap-2"><i data-lucide="message-circle"></i> WHATSAPP</button>
                </div>
                <div class="flex gap-2 pt-2 border-t border-[#222] mt-2">
                     <select id="orderStatusUpdate" class="cyber-input flex-1 p-2 text-xs uppercase">
                        <option value="pending">PENDIENTE</option>
                        <option value="completed">COMPLETADO</option>
                        <option value="cancelled">CANCELADO</option>
                     </select>
                     <button id="btnUpdateStatus" class="bg-[#333] text-white px-4 text-xs font-bold hover:bg-white hover:text-black">ACTUALIZAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGICA -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, getDoc, serverTimestamp, query, orderBy, increment, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        const IMGBB_API_KEY = "b922654effe3a1ab5ac85cc4c23f97b8"; 
        const firebaseConfig = { apiKey: "AIzaSyAztg4F0twRi2NOP8MayAOUYB0ZtHgkss0", authDomain: "kodialabsnic.firebaseapp.com", projectId: "kodialabsnic", storageBucket: "kodialabsnic.firebasestorage.app", messagingSenderId: "740746852984", appId: "1:740746852984:web:972aa34592aef881630b8d" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);

        let products = []; let posCart = []; let currentOrder = null;
        let pendingPosProduct = null; let lastSaleOrder = null;
        let globalSettings = {}; 

        // AUTH & INIT
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-overlay').classList.add('hidden');
                await loadLandingConfig(); 
                loadProducts(); loadOrders();
            } else {
                try {
                    const s = await getDoc(doc(db, "settings", "landing_page_v2"));
                    if(s.exists() && s.data().logo) {
                        document.getElementById('loginLogo').src = s.data().logo;
                        document.getElementById('loginLogo').classList.remove('hidden');
                    }
                } catch(e){}
                document.getElementById('login-overlay').classList.remove('hidden');
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); }
            catch (error) { document.getElementById('loginError').innerText = "Credenciales inv√°lidas"; document.getElementById('loginError').classList.remove('hidden'); }
        });

        window.logout = () => signOut(auth);

        // --- GESTI√ìN PRODUCTOS ---
        async function loadProducts() {
            const grid = document.getElementById('productsGrid'); grid.innerHTML = 'Wait...';
            const posGrid = document.getElementById('posGrid'); posGrid.innerHTML = '';
            
            const q = collection(db, "products"); const snap = await getDocs(q);
            products = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

            grid.innerHTML = '';
            products.forEach(p => {
                let totalStock = 0;
                if (p.variants) Object.values(p.variants).forEach(qty => totalStock += Number(qty));
                else totalStock = '‚àû';

                // Admin Grid
                const card = document.createElement('div');
                card.className = `cyber-card p-4 flex flex-col gap-3 ${!p.isActive ? 'opacity-50' : ''}`;
                card.innerHTML = `
                    <div class="aspect-square bg-[#111] border border-[#222] relative">
                        <img src="${p.image || ''}" class="w-full h-full object-cover">
                        <div class="absolute bottom-0 right-0 bg-[#ccff00] text-black text-xs font-bold px-2">STOCK: ${totalStock}</div>
                    </div>
                    <div><div class="font-bold text-white truncate">${p.name}</div><div class="text-[#ff003c] font-mono">C$ ${p.price}</div></div>
                    <button onclick="openModal('${p.id}')" class="bg-[#111] border border-[#333] text-white text-xs py-2 hover:bg-white hover:text-black">EDITAR</button>
                `;
                grid.appendChild(card);

                // POS Grid
                if(p.isActive !== false) {
                    const posItem = document.createElement('div');
                    posItem.className = "bg-[#111] border border-[#333] p-2 flex gap-2 cursor-pointer hover:border-[#ccff00] active:scale-95 transition-transform";
                    posItem.onclick = () => addToPos(p.id);
                    posItem.innerHTML = `<img src="${p.image}" class="w-12 h-12 object-cover bg-black"><div class="overflow-hidden"><div class="text-xs font-bold text-white truncate">${p.name}</div><div class="text-[#ccff00] text-xs">C$ ${p.price}</div></div>`;
                    posGrid.appendChild(posItem);
                }
            });
            lucide.createIcons();
        }

        // --- POS SYSTEM (L√≥gica Nativa) ---
        window.addToPos = (id) => {
            const p = products.find(x => x.id === id);
            if(!p) return;
            const sizes = p.variants ? Object.keys(p.variants) : (p.sizes || ['U']);
            
            if(sizes.length === 1 && sizes[0] === 'U') {
                 addPosItemToCart(p, 'U');
            } else {
                pendingPosProduct = p;
                document.getElementById('posVariantProductName').innerText = p.name;
                const container = document.getElementById('posVariantOptions');
                container.innerHTML = '';
                sizes.forEach(size => {
                    const stock = p.variants ? p.variants[size] : '‚àû';
                    const hasStock = stock === '‚àû' || stock > 0;
                    const btn = document.createElement('button');
                    btn.className = `p-3 border transition-all ${hasStock ? 'border-[#333] hover:border-[#ccff00] hover:bg-[#222] text-white' : 'border-red-900/50 text-red-700 bg-red-900/10 cursor-not-allowed'} font-mono text-xs flex justify-between items-center group`;
                    btn.disabled = !hasStock;
                    btn.innerHTML = `<span class="font-bold">${size}</span> <span class="${hasStock ? 'text-[#ccff00]' : 'text-red-500'} group-hover:text-white">${stock}</span>`;
                    btn.onclick = () => { if(hasStock) { addPosItemToCart(pendingPosProduct, size); closePosVariantModal(); } };
                    container.appendChild(btn);
                });
                document.getElementById('posVariantModal').classList.remove('hidden');
            }
        }
        window.closePosVariantModal = () => document.getElementById('posVariantModal').classList.add('hidden');
        window.addPosItemToCart = (product, size) => {
            if (product.variants && product.variants[size] <= 0) return; // Silent fail if no stock clicked
            posCart.push({ ...product, size: size, qty: 1 }); renderPosCart();
        }
        window.clearPosCart = () => { posCart = []; renderPosCart(); document.getElementById('posClientName').value = ''; document.getElementById('posClientPhone').value = ''; }
        
        window.renderPosCart = () => {
            const c = document.getElementById('posCart'); c.innerHTML = '';
            let total = 0;
            if(posCart.length === 0) c.innerHTML = '<div class="text-center text-gray-600 text-xs mt-10 italic">Carrito Vac√≠o</div>';
            
            posCart.forEach((item, i) => {
                total += item.price;
                c.innerHTML += `<div class="flex justify-between items-center bg-[#111] p-3 border-l-4 border-[#ccff00] mb-2"><div class="text-xs"><div class="text-white font-bold">${item.name} (${item.size})</div><div class="text-gray-500">C$ ${item.price}</div></div><button onclick="posCart.splice(${i},1);renderPosCart()" class="text-red-500 hover:text-white"><i data-lucide="trash-2" width="14"></i></button></div>`;
            });
            document.getElementById('posTotal').innerText = `C$ ${total.toFixed(2)}`;
            lucide.createIcons();
        }

        // --- FLUJO DE COBRO NATIVO ---
        window.openPaymentModal = () => {
            if(posCart.length === 0) return; // No hacer nada si est√° vac√≠o
            
            const total = posCart.reduce((a,b)=>a+b.price, 0);
            const client = document.getElementById('posClientName').value || "Consumidor Final";
            
            document.getElementById('confClient').innerText = client;
            document.getElementById('confItems').innerText = `${posCart.length} Productos`;
            document.getElementById('confTotal').innerText = `C$ ${total.toFixed(2)}`;
            
            // Seleccionar efectivo por defecto
            window.selectPayment('Efectivo');
            document.getElementById('posPaymentModal').classList.remove('hidden');
        }
        
        window.selectPayment = (method) => {
            document.querySelectorAll('.pay-opt').forEach(b => {
                b.classList.remove('bg-[#ccff00]', 'text-black');
                if(b.innerText.includes(method.toUpperCase())) b.classList.add('bg-[#ccff00]', 'text-black');
            });
            document.getElementById('selectedPaymentMethod').value = method;
        }

        window.closePaymentModal = () => document.getElementById('posPaymentModal').classList.add('hidden');

        window.confirmPosSale = async () => {
            const btn = document.getElementById('btnProcessPayment');
            btn.innerHTML = "PROCESANDO..."; btn.disabled = true;

            const clientName = document.getElementById('posClientName').value.trim() || "Consumidor Final";
            const clientPhone = document.getElementById('posClientPhone').value.trim() || "";
            const paymentMethod = document.getElementById('selectedPaymentMethod').value;
            const total = posCart.reduce((a,b)=>a+b.price, 0);

            const batch = writeBatch(db);
            const randomId = Math.floor(1000 + Math.random() * 9000);
            const datePart = new Date().toISOString().slice(2,10).replace(/-/g,''); 
            const orderId = `ORD-${datePart}-${randomId}`;
            
            const orderData = {
                orderId, date: serverTimestamp(),
                customer: { name: clientName, phone: clientPhone, detail: "Venta en Tienda (POS)" },
                items: posCart, total: total, paymentMethod: paymentMethod,
                source: 'POS', status: 'completed'
            };

            const orderRef = doc(collection(db, "orders"));
            batch.set(orderRef, orderData);

            posCart.forEach(item => {
                const prodRef = doc(db, "products", item.id);
                if(item.variants) { batch.update(prodRef, { [`variants.${item.size}`]: increment(-1) }); }
            });

            await batch.commit();

            // EXITO - NO ALERTAS - PANTALLA DE RECIBO
            lastSaleOrder = { id: orderRef.id, ...orderData, date: { seconds: Date.now()/1000 } }; // Mock date for immediate display
            document.getElementById('successOrderId').innerText = orderId;
            
            closePaymentModal();
            document.getElementById('posSuccessModal').classList.remove('hidden');
            
            loadProducts(); loadOrders(); // Actualizar background
            btn.innerHTML = "PROCESAR VENTA"; btn.disabled = false;
        }

        window.resetPos = () => {
            posCart = []; renderPosCart();
            document.getElementById('posClientName').value = '';
            document.getElementById('posClientPhone').value = '';
            document.getElementById('posSuccessModal').classList.add('hidden');
        }

        // --- ACCIONES R√ÅPIDAS RECIBO ---
        window.downloadLastInvoice = () => {
            if(lastSaleOrder) {
                currentOrder = lastSaleOrder; // Hack para reutilizar funcion
                generateInvoice(lastSaleOrder.id);
            }
        }
        window.sendLastWhatsapp = () => {
             if(lastSaleOrder) {
                 const o = lastSaleOrder;
                 const itemsList = o.items.map(i => `‚Ä¢ ${i.qty}x ${i.name} (${i.size})`).join('%0A');
                 const msg = `*RECIBO DE COMPRA KURA* üéå%0A%0AOrden: *${o.orderId}*%0ACliente: ${o.customer.name}%0A%0A*Art√≠culos:*%0A${itemsList}%0A%0A*TOTAL PAGADO:* C$ ${o.total.toFixed(2)}`;
                 window.open(`https://wa.me/505${o.customer.phone}?text=${msg}`, '_blank');
             }
        }

        // --- FACTURA PDF GENERATOR (IMPRESI√ìN DIRECTA) ---
        window.generateInvoice = async (orderId) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const o = currentOrder; 
            if(!o) return;

            const logoUrl = globalSettings.logo || "";
            const shopName = globalSettings.title || "KURA STUDIO";

            if(logoUrl) { try { doc.addImage(logoUrl, 'JPEG', 15, 15, 20, 20); } catch(e){} }

            doc.setFontSize(22); doc.setFont("helvetica", "bold"); doc.text(shopName, 40, 25);
            doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("RUC: J0310000000000", 40, 30); doc.text("Managua, Nicaragua", 40, 35);

            doc.setFontSize(12); doc.text(`FACTURA #${o.orderId}`, 140, 25);
            doc.setFontSize(10);
            const dateStr = o.date ? new Date(o.date.seconds*1000).toLocaleDateString() : new Date().toLocaleDateString();
            doc.text(`Fecha: ${dateStr}`, 140, 32); doc.text(`Estado: ${o.status.toUpperCase()}`, 140, 39);

            doc.setDrawColor(200); doc.line(15, 45, 195, 45);
            doc.setFont("helvetica", "bold"); doc.text("CLIENTE:", 15, 52);
            doc.setFont("helvetica", "normal"); doc.text(`${o.customer.name}`, 15, 58);

            const tableBody = o.items.map(i => [ i.qty, `${i.name} (${i.size})`, `C$ ${i.price.toFixed(2)}`, `C$ ${(i.price * i.qty).toFixed(2)}` ]);

            doc.autoTable({ startY: 70, head: [['Cant', 'Descripci√≥n', 'Unit', 'Total']], body: tableBody, theme: 'striped', headStyles: { fillColor: [0, 0, 0] } });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFont("helvetica", "bold"); doc.text(`TOTAL: C$ ${o.total.toFixed(2)}`, 140, finalY);

            // AUTO-PRINT
            doc.autoPrint(); 
            window.open(doc.output('bloburl'), '_blank');
        }

        // --- COMMON & MODALS ---
        async function loadOrders() {
            const tbody = document.getElementById('ordersTableBody');
            const q = query(collection(db, "orders"), orderBy("date", "desc"));
            const snap = await getDocs(q);
            tbody.innerHTML = '';
            snap.forEach(doc => {
                const o = doc.data();
                const statusColor = o.status === 'completed' ? 'text-green-500' : o.status === 'cancelled' ? 'text-red-500' : 'text-yellow-500';
                tbody.innerHTML += `<tr class="hover:bg-[#111] border-b border-[#222]"><td class="p-4 text-[#ccff00] font-mono text-xs">${o.orderId || 'N/A'}</td><td class="p-4 text-xs text-gray-500">${o.date ? new Date(o.date.seconds*1000).toLocaleDateString() : '-'}</td><td class="p-4 text-xs font-bold text-white">${o.customer?.name}</td><td class="p-4 text-xs">C$ ${o.total}</td><td class="p-4 text-xs">${o.paymentMethod || '-'}</td><td class="p-4 text-xs font-bold uppercase ${statusColor}">${o.status || 'pending'}</td><td class="p-4"><button onclick="viewOrder('${doc.id}')" class="text-white hover:text-[#ff003c]"><i data-lucide="eye" width="16"></i></button></td></tr>`;
            });
            lucide.createIcons();
        }

        window.viewOrder = async (id) => {
            const snap = await getDoc(doc(db, "orders", id));
            currentOrder = { id: snap.id, ...snap.data() };
            const o = currentOrder;
            
            document.getElementById('modalOrderId').innerText = o.orderId;
            document.getElementById('orderStatusUpdate').value = o.status || 'pending';
            
            // --- RESTAURACI√ìN DEL HTML DE DETALLE ---
            let html = `
                <div class="bg-[#050505] p-4 border border-[#333] mb-4 space-y-3">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase tracking-widest">CLIENTE</div>
                            <div class="text-white font-bold">${o.customer.name}</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase tracking-widest">TEL√âFONO</div>
                            <div class="text-[#ccff00] font-mono">${o.customer.phone || 'N/A'}</div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="text-[10px] text-gray-500 uppercase tracking-widest">DIRECCI√ìN / DETALLE</div>
                        <div class="text-white text-sm bg-[#111] p-2 border border-[#333] mt-1">${o.customer.detail || 'N/A'}</div>
                        ${o.destination ? `<a href="https://maps.google.com/?q=${o.destination.lat},${o.destination.lng}" target="_blank" class="text-[#ff003c] text-xs font-bold mt-2 inline-flex items-center gap-1 hover:underline"><i data-lucide="map-pin" width="12"></i> VER UBICACI√ìN GPS</a>` : ''}
                    </div>

                    <div class="grid grid-cols-2 gap-4 pt-2 border-t border-[#222]">
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase tracking-widest">M√âTODO PAGO</div>
                            <div class="text-white font-bold">${o.paymentMethod || 'N/A'}</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase tracking-widest">ESTADO ACTUAL</div>
                            <div class="text-${o.status === 'completed' ? 'green' : o.status === 'cancelled' ? 'red' : 'yellow'}-500 font-bold uppercase">${o.status || 'PENDING'}</div>
                        </div>
                    </div>
                </div>

                <div class="space-y-1 mb-4">
                    <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-2">ITEMS COMPRADOS</div>
                    ${o.items.map(i => `
                    <div class="flex justify-between items-center bg-[#111] p-2 border-b border-[#222]">
                        <div class="flex gap-3 items-center">
                            ${i.image ? `<img src="${i.image}" class="w-10 h-10 object-cover bg-black border border-[#333]">` : `<div class="w-10 h-10 bg-[#222]"></div>`}
                            <div>
                                <div class="text-white text-xs font-bold">${i.qty}x ${i.name}</div>
                                <div class="text-gray-500 text-[10px]">Talla: ${i.size}</div>
                            </div>
                        </div>
                        <div class="text-[#ccff00] text-xs font-mono">C$ ${(i.price * i.qty).toFixed(2)}</div>
                    </div>`).join('')}
                </div>
                
                <div class="flex justify-between items-end bg-[#ccff00] text-black p-3 font-bold text-xl">
                    <span>TOTAL PAGADO</span>
                    <span>C$ ${o.total.toFixed(2)}</span>
                </div>
            `;
            
            document.getElementById('orderDetailContent').innerHTML = html;
            
            document.getElementById('btnDownloadInvoice').onclick = () => generateInvoice(o.id);
            document.getElementById('btnSendWhatsapp').onclick = () => { window.open(`https://wa.me/505${o.customer.phone}?text=Orden ${o.orderId} Detalle...`, '_blank'); };
            
            // Evento para actualizar estado
            document.getElementById('btnUpdateStatus').onclick = async () => {
                const newStatus = document.getElementById('orderStatusUpdate').value;
                await updateDoc(doc(db, "orders", id), { status: newStatus });
                alert("Estado actualizado"); loadOrders(); closeOrderModal();
            };

            lucide.createIcons();
            document.getElementById('orderModal').classList.remove('hidden');
        }
        window.closeOrderModal = () => document.getElementById('orderModal').classList.add('hidden');

        // Helpers
        window.saveLandingConfig = async () => { /* Same as before */ await setDoc(doc(db, "settings", "landing_page_v2"), {title: document.getElementById('landingTitle').value, subtitle: document.getElementById('landingSubtitle').value, bgImage: document.getElementById('landingBgImage').value, logo: document.getElementById('landingLogo').value, btnText: document.getElementById('landingBtnText').value, storeUrl: document.getElementById('landingStoreUrl').value, instagram: document.getElementById('landingInsta').value, whatsapp: document.getElementById('landingWhatsapp').value, tiktok: document.getElementById('landingTiktok').value}, { merge: true }); alert("Guardado"); }
        async function loadLandingConfig() { try { const s = await getDoc(doc(db, "settings", "landing_page_v2")); if(s.exists()) { globalSettings = s.data(); document.getElementById('landingTitle').value = globalSettings.title||''; document.getElementById('landingSubtitle').value = globalSettings.subtitle||''; document.getElementById('landingBgImage').value = globalSettings.bgImage||''; document.getElementById('landingLogo').value = globalSettings.logo||''; document.getElementById('landingBtnText').value = globalSettings.btnText||''; document.getElementById('landingStoreUrl').value = globalSettings.storeUrl||''; document.getElementById('landingInsta').value = globalSettings.instagram||''; document.getElementById('landingWhatsapp').value = globalSettings.whatsapp||''; document.getElementById('landingTiktok').value = globalSettings.tiktok||''; } } catch(e){} }
        window.switchTab = (t) => { document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden')); document.getElementById(`view-${t}`).classList.remove('hidden'); }
        window.openModal = (id) => { /* Same Product Modal Logic */ if(id){ const p=products.find(x=>x.id===id); window.tempVariants={...p.variants}; document.getElementById('modalTitle').innerText="EDITAR"; document.getElementById('editId').value=p.id; document.getElementById('name').value=p.name; document.getElementById('price').value=p.price; document.getElementById('currentImageUrl').value=p.image; document.getElementById('isActive').checked=p.isActive!==false; if(p.image)document.getElementById('imgPreview').src=p.image; } else { window.tempVariants={S:10,M:10,L:10}; document.getElementById('modalTitle').innerText="NUEVO"; document.getElementById('editId').value=""; document.getElementById('productForm').reset(); } renderVariants(); document.getElementById('productModal').classList.remove('hidden'); setTimeout(()=>document.getElementById('modalContent').classList.remove('translate-x-full'),10); }
        window.renderVariants = () => { const l=document.getElementById('variantsList'); l.innerHTML=''; Object.entries(window.tempVariants).forEach(([k,v])=>l.innerHTML+=`<div class="flex justify-between items-center bg-[#111] p-2 border border-[#333] text-xs text-white"><span>${k}</span><span>${v}</span><button onclick="delete window.tempVariants['${k}']; renderVariants()" class="text-red-500">x</button></div>`); document.getElementById('variantsData').value=JSON.stringify(window.tempVariants); }
        window.addVariant = () => { const s=document.getElementById('newVariantSize').value.toUpperCase(); const q=parseInt(document.getElementById('newVariantQty').value); if(s&&!isNaN(q)){window.tempVariants[s]=q; renderVariants();} }
        window.closeModal = () => { document.getElementById('modalContent').classList.add('translate-x-full'); setTimeout(()=>document.getElementById('productModal').classList.add('hidden'),300); }
        document.getElementById('productForm').addEventListener('submit', async (e) => { e.preventDefault(); /* Same Save Logic */ const id=document.getElementById('editId').value; const d={name:document.getElementById('name').value, price:parseFloat(document.getElementById('price').value), image: document.getElementById('currentImageUrl').value, variants:JSON.parse(document.getElementById('variantsData').value), isActive:document.getElementById('isActive').checked, category:document.getElementById('category').value, description:document.getElementById('description').value, updatedAt: serverTimestamp()}; if(id) await updateDoc(doc(db,"products",id),d); else { d.createdAt=serverTimestamp(); await addDoc(collection(db,"products"),d); } closeModal(); loadProducts(); });
        window.uploadImage = async (f) => { const fd=new FormData(); fd.append("image",f); const r=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:fd}); const j=await r.json(); return j.data.url; }
        window.previewFile = async () => { const f=document.getElementById('imageFile').files[0]; if(f) document.getElementById('currentImageUrl').value = await window.uploadImage(f); }
        window.filterPos = () => { const q=document.getElementById('posSearch').value.toLowerCase(); for(let c of document.getElementById('posGrid').children) c.style.display=c.innerText.toLowerCase().includes(q)?'flex':'none'; }

        lucide.createIcons();
    </script>
</body>
</html>
