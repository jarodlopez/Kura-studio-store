<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KURA | ADMIN ACCESS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root { --neon-red: #ff003c; --acid-green: #ccff00; --cyber-black: #050505; --dark-gray: #111; }
        body { font-family: 'Chakra Petch', sans-serif; background-color: var(--cyber-black); color: #e5e5e5; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* UI Components */
        .cyber-input {
            background: var(--dark-gray); border: 1px solid #333; color: white;
            font-family: 'JetBrains Mono', monospace; transition: all 0.2s;
        }
        .cyber-input:focus { border-color: var(--acid-green); outline: none; }
        
        .cyber-btn {
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: all 0.2s; text-transform: uppercase; font-weight: bold; letter-spacing: 1px;
        }
        .cyber-btn:hover { transform: translateY(-2px); filter: brightness(1.2); }
        
        .cyber-card { border: 1px solid #222; background: #0a0a0a; position: relative; }
        .cyber-card:hover { border-color: var(--neon-red); }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: var(--acid-green); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--acid-green); }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #000; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--neon-red); }

        /* Login Overlay */
        #login-overlay {
            background-image: radial-gradient(circle at center, #111 0%, #000 100%);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row overflow-hidden relative">

    <!-- LOGIN SCREEN (Cubre todo hasta que inicies sesión) -->
    <div id="login-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md bg-[#0a0a0a] border border-[#333] p-8 shadow-[0_0_50px_rgba(0,0,0,0.8)] relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#ff003c] to-[#ccff00]"></div>
            
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black italic tracking-tighter text-white mb-2">KURA<span class="text-[#ff003c]">ADMIN</span></h1>
                <p class="text-[10px] font-mono text-neutral-500">ACCESO RESTRINGIDO // SOLO PERSONAL AUTORIZADO</p>
            </div>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-mono text-neutral-500 mb-1 uppercase">Correo Electrónico</label>
                    <input type="email" id="email" class="cyber-input w-full p-3 text-sm" placeholder="admin@kurastudio.com" required>
                </div>
                <div>
                    <label class="block text-[10px] font-mono text-neutral-500 mb-1 uppercase">Contraseña</label>
                    <input type="password" id="password" class="cyber-input w-full p-3 text-sm" placeholder="••••••••" required>
                </div>
                <div id="loginError" class="text-red-500 text-xs font-mono hidden"></div>
                <button type="submit" id="loginBtn" class="cyber-btn w-full bg-[#ff003c] text-white py-3 mt-4 flex items-center justify-center gap-2">
                    <i data-lucide="lock"></i> INICIAR SESIÓN
                </button>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-full md:w-64 bg-[#0a0a0a] border-r border-[#222] flex flex-col z-20">
        <div class="p-6 border-b border-[#222]">
            <h1 class="text-2xl font-black italic tracking-tighter text-white">KURA<span class="text-[#ff003c]">ADMIN</span></h1>
            <p class="text-[10px] text-neutral-500 font-mono mt-1">SYSTEM V3.0 SECURE</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('products')" id="tab-products" class="w-full text-left p-3 bg-[#111] text-[#ccff00] border-l-2 border-[#ccff00] flex items-center gap-3 font-bold transition-all">
                <i data-lucide="package"></i> INVENTARIO
            </button>
            <button onclick="switchTab('orders')" id="tab-orders" class="w-full text-left p-3 hover:bg-[#111] text-neutral-400 border-l-2 border-transparent hover:border-white flex items-center gap-3 transition-all">
                <i data-lucide="shopping-cart"></i> ÓRDENES
            </button>
        </nav>
        <div class="p-4 border-t border-[#222]">
            <button onclick="logout()" class="w-full text-left text-xs font-mono text-red-500 hover:text-white flex items-center gap-2">
                <i data-lucide="log-out" width="14"></i> CERRAR SESIÓN
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 bg-black relative overflow-y-auto h-screen custom-scrollbar">
        
        <!-- VISTA PRODUCTOS -->
        <div id="view-products" class="p-6 md:p-10 space-y-6 pb-24">
            <div class="flex justify-between items-center sticky top-0 bg-black/90 backdrop-blur z-10 py-4 border-b border-[#222]">
                <h2 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="box"></i> GESTIÓN DE PRODUCTOS</h2>
                <button onclick="openModal()" class="cyber-btn bg-[#ccff00] text-black px-6 py-3 flex items-center gap-2">
                    <i data-lucide="plus"></i> NUEVO ITEM
                </button>
            </div>

            <!-- Grid de Productos -->
            <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <div class="col-span-full text-center py-20 text-neutral-500 animate-pulse">ESPERANDO AUTENTICACIÓN...</div>
            </div>
        </div>

        <!-- VISTA ÓRDENES -->
        <div id="view-orders" class="hidden p-6 md:p-10 space-y-6 pb-24">
            <h2 class="text-xl font-bold text-white flex items-center gap-2 sticky top-0 bg-black py-4 z-10"><i data-lucide="list-ordered"></i> ÓRDENES RECIBIDAS</h2>
            <div class="overflow-x-auto border border-[#222] bg-[#0a0a0a]">
                <table class="w-full text-left text-sm">
                    <thead class="bg-[#111] text-neutral-400 font-mono text-xs uppercase">
                        <tr>
                            <th class="p-4">Orden ID</th>
                            <th class="p-4">Fecha</th>
                            <th class="p-4">Cliente</th>
                            <th class="p-4">Total</th>
                            <th class="p-4">Status</th>
                            <th class="p-4">Ver</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody" class="divide-y divide-[#222] text-neutral-300"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- MODAL PRODUCTO (CREAR/EDITAR) -->
    <div id="productModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="absolute top-0 right-0 h-full w-full md:w-[500px] bg-[#0f0f0f] border-l border-[#222] shadow-2xl transform transition-transform duration-300 translate-x-full flex flex-col" id="modalContent">
            
            <div class="p-6 border-b border-[#222] flex justify-between items-center bg-[#111]">
                <h3 id="modalTitle" class="text-lg font-bold text-white uppercase">NUEVO PRODUCTO</h3>
                <button onclick="closeModal()" class="text-neutral-500 hover:text-white"><i data-lucide="x"></i></button>
            </div>

            <form id="productForm" class="flex-1 overflow-y-auto p-6 space-y-5 custom-scrollbar">
                <input type="hidden" id="editId">
                <input type="hidden" id="currentImageUrl">

                <!-- Toggle Activo -->
                <div class="flex items-center justify-between bg-[#050505] p-3 border border-[#222]">
                    <span class="text-xs font-bold uppercase text-white">Visible en Tienda</span>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none">
                        <input type="checkbox" id="isActive" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 checked:border-[#ccff00] transition-all"/>
                        <label for="isActive" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-800 cursor-pointer border border-[#333]"></label>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-mono text-neutral-500 mb-1">NOMBRE</label>
                    <input type="text" id="name" required class="cyber-input w-full p-3 text-sm">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-mono text-neutral-500 mb-1">PRECIO (C$)</label>
                        <input type="number" id="price" required class="cyber-input w-full p-3 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-[#ff003c] mb-1 font-bold">PRECIO ANTERIOR</label>
                        <input type="number" id="comparePrice" class="cyber-input w-full p-3 text-sm border-[#ff003c]/30" placeholder="Para Ofertas">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-mono text-neutral-500 mb-1">CATEGORÍA</label>
                    <select id="category" class="cyber-input w-full p-3 text-sm uppercase">
                        <option value="TOPS">TOPS</option>
                        <option value="BOTTOMS">BOTTOMS</option>
                        <option value="OUTERWEAR">OUTERWEAR</option>
                        <option value="ACCESSORIES">ACCESSORIES</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-mono text-neutral-500 mb-1">TALLAS (Separadas por coma)</label>
                    <input type="text" id="sizes" class="cyber-input w-full p-3 text-sm" placeholder="S, M, L, XL">
                </div>

                <div>
                    <label class="block text-xs font-mono text-neutral-500 mb-1">DESCRIPCIÓN</label>
                    <textarea id="description" rows="3" class="cyber-input w-full p-3 text-sm"></textarea>
                </div>

                <div>
                    <label class="block text-xs font-mono text-neutral-500 mb-1">IMAGEN (Subida vía ImgBB)</label>
                    <input type="file" id="imageFile" accept="image/*" class="cyber-input w-full p-2 text-xs" onchange="previewFile()">
                    <div id="previewBox" class="mt-2 h-48 bg-black border border-[#222] flex items-center justify-center hidden relative group">
                        <img id="imgPreview" src="" class="h-full object-contain">
                    </div>
                </div>
            </form>

            <div class="p-6 border-t border-[#222] bg-[#0a0a0a]">
                <button form="productForm" id="saveBtn" class="cyber-btn w-full bg-[#ff003c] text-white py-4 flex items-center justify-center gap-2">
                    <i data-lucide="save"></i> GUARDAR CAMBIOS
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DETALLE ORDEN -->
    <div id="orderModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="document.getElementById('orderModal').classList.add('hidden')"></div>
        <div class="bg-[#111] border border-[#333] w-full max-w-lg relative z-10 p-6 shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
            <h3 class="text-[#ccff00] font-mono text-xl font-bold mb-4">DETALLE DE ORDEN</h3>
            <div id="orderDetailContent" class="space-y-4 text-sm text-neutral-300"></div>
            <button onclick="document.getElementById('orderModal').classList.add('hidden')" class="mt-6 w-full border border-white py-2 hover:bg-white hover:text-black transition uppercase font-bold text-xs">Cerrar</button>
        </div>
    </div>

    <!-- LOGICA FIREBASE + IMGBB + LOGIN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        // CONFIGURACIÓN API KEYS
        const IMGBB_API_KEY = "b922654effe3a1ab5ac85cc4c23f97b8"; 

        const firebaseConfig = {
            apiKey: "AIzaSyAztg4F0twRi2NOP8MayAOUYB0ZtHgkss0",
            authDomain: "kodialabsnic.firebaseapp.com",
            projectId: "kodialabsnic",
            storageBucket: "kodialabsnic.firebasestorage.app",
            messagingSenderId: "740746852984",
            appId: "1:740746852984:web:972aa34592aef881630b8d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let products = [];
        let orders = [];

        // --- SISTEMA DE LOGIN ---
        
        // 1. Escuchar estado de autenticación
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario logueado
                document.getElementById('login-overlay').classList.add('hidden');
                loadProducts();
            } else {
                // No logueado
                document.getElementById('login-overlay').classList.remove('hidden');
            }
        });

        // 2. Manejar Formulario de Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('loginBtn');
            const errorMsg = document.getElementById('loginError');

            btn.disabled = true;
            btn.innerHTML = "VERIFICANDO...";
            errorMsg.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // El onAuthStateChanged se encargará de ocultar el modal
            } catch (error) {
                console.error(error);
                errorMsg.innerText = "Error: Credenciales incorrectas o usuario no encontrado.";
                errorMsg.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="lock"></i> INICIAR SESIÓN`;
                lucide.createIcons();
            }
        });

        // 3. Función Logout
        window.logout = () => {
            if(confirm("¿Cerrar sesión de administrador?")) {
                signOut(auth);
            }
        }

        // --- GESTIÓN DE PRODUCTOS (CORREGIDA) ---
        async function loadProducts() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '<div class="col-span-full text-center py-20"><i data-lucide="loader-2" class="animate-spin inline mr-2"></i> Cargando Base de Datos...</div>';
            lucide.createIcons();

            try {
                // ⚠️ CAMBIO CRÍTICO: Quitamos el 'orderBy' temporalmente.
                // Esto permite que se descarguen productos aunque no tengan fecha de creación,
                // solucionando el problema de que no se veían tus productos anteriores.
                const q = collection(db, "products"); 
                const snap = await getDocs(q);
                
                // Ordenamos en memoria (JavaScript) para evitar errores de índices en Firebase
                products = snap.docs.map(d => ({id:d.id, ...d.data()}))
                                    .sort((a, b) => {
                                        // Si tienen fecha, usarla. Si no, poner al final.
                                        const tA = a.createdAt ? a.createdAt.seconds : 0;
                                        const tB = b.createdAt ? b.createdAt.seconds : 0;
                                        return tB - tA; // Descendente
                                    });

                grid.innerHTML = '';
                
                if(products.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center py-20 text-neutral-500">Inventario vacío. Agrega tu primer producto.</div>';
                    return;
                }

                products.forEach(p => {
                    const active = p.isActive !== false;
                    const hasDiscount = p.comparePrice && p.comparePrice > p.price;
                    const discountPct = hasDiscount ? Math.round(((p.comparePrice - p.price) / p.comparePrice) * 100) : 0;
                    // Fallback de imagen si no tiene
                    const imgUrl = p.image || "https://via.placeholder.com/300x400?text=No+Image";

                    const card = document.createElement('div');
                    card.className = `cyber-card p-4 flex flex-col gap-3 transition-all ${!active ? 'opacity-50 grayscale' : ''}`;
                    card.innerHTML = `
                        <div class="relative aspect-[3/4] bg-[#111] border border-[#222] group overflow-hidden">
                            <img src="${imgUrl}" class="w-full h-full object-cover">
                            ${!active ? '<div class="absolute inset-0 bg-black/60 flex items-center justify-center font-bold text-red-500 border-2 border-red-500 m-4">DESACTIVADO</div>' : ''}
                            ${hasDiscount ? `<div class="absolute top-2 right-2 bg-[#ccff00] text-black text-[10px] font-bold px-2 py-1">-${discountPct}%</div>` : ''}
                        </div>
                        <div>
                            <h3 class="font-bold text-white uppercase truncate text-sm">${p.name || 'Sin Nombre'}</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[#ff003c] font-mono font-bold">C$ ${p.price || 0}</span>
                                ${hasDiscount ? `<span class="text-neutral-500 line-through text-xs font-mono">C$ ${p.comparePrice}</span>` : ''}
                            </div>
                            <div class="text-[10px] text-neutral-500 mt-1 truncate">${(p.sizes || []).join(', ')}</div>
                        </div>
                        <div class="mt-auto pt-3 flex gap-2">
                            <button onclick="openModal('${p.id}')" class="flex-1 bg-[#111] hover:bg-white hover:text-black text-[10px] font-bold py-2 border border-[#333] transition-colors">EDITAR</button>
                            <button onclick="toggleActive('${p.id}', ${!active})" class="px-3 border border-[#333] hover:bg-[#333] text-white">
                                <i data-lucide="${active ? 'eye' : 'eye-off'}" width="14"></i>
                            </button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                lucide.createIcons();
            } catch (error) {
                console.error(error);
                grid.innerHTML = `<div class="col-span-full text-center py-20 text-red-500">Error cargando productos: ${error.message}</div>`;
            }
        }

        // TABS
        window.switchTab = (tab) => {
            document.getElementById('view-products').classList.add('hidden');
            document.getElementById('view-orders').classList.add('hidden');
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            
            const btnP = document.getElementById('tab-products');
            const btnO = document.getElementById('tab-orders');
            
            if(tab === 'products') {
                btnP.className = "w-full text-left p-3 bg-[#111] text-[#ccff00] border-l-2 border-[#ccff00] flex items-center gap-3 font-bold transition-all";
                btnO.className = "w-full text-left p-3 hover:bg-[#111] text-neutral-400 border-l-2 border-transparent hover:border-white flex items-center gap-3 transition-all";
            } else {
                btnO.className = "w-full text-left p-3 bg-[#111] text-[#ccff00] border-l-2 border-[#ccff00] flex items-center gap-3 font-bold transition-all";
                btnP.className = "w-full text-left p-3 hover:bg-[#111] text-neutral-400 border-l-2 border-transparent hover:border-white flex items-center gap-3 transition-all";
                loadOrders();
            }
        }

        // CARGAR ÓRDENES
        async function loadOrders() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center"><i data-lucide="loader-2" class="animate-spin inline mr-2"></i> Cargando...</td></tr>';
            lucide.createIcons();

            try {
                const q = query(collection(db, "orders"), orderBy("date", "desc"));
                const snap = await getDocs(q);
                orders = snap.docs.map(d => ({id:d.id, ...d.data()}));
                
                tbody.innerHTML = '';
                if(orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-neutral-500">No hay órdenes registradas.</td></tr>';
                    return;
                }

                orders.forEach(o => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-[#111] transition-colors";
                    const dateObj = o.date ? new Date(o.date.seconds * 1000) : new Date();
                    
                    tr.innerHTML = `
                        <td class="p-4 font-mono text-[#ccff00] text-xs">${o.orderId || '---'}</td>
                        <td class="p-4 text-xs text-neutral-400">${dateObj.toLocaleDateString()}</td>
                        <td class="p-4 text-xs">
                            <div class="font-bold text-white">${o.customer?.name || 'Anon'}</div>
                        </td>
                        <td class="p-4 font-bold text-xs">C$ ${o.total}</td>
                        <td class="p-4"><span class="bg-blue-900/50 text-blue-200 text-[10px] px-2 py-1 border border-blue-800 rounded">NUEVA</span></td>
                        <td class="p-4">
                            <button onclick="viewOrder('${o.id}')" class="text-white hover:text-[#ff003c]"><i data-lucide="eye" width="16"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            } catch (e) {
                console.log(e);
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Error leyendo órdenes.</td></tr>`;
            }
        }

        // MODAL LOGIC
        const modalEl = document.getElementById('productModal');
        const modalContent = document.getElementById('modalContent');

        window.openModal = (id = null) => {
            document.getElementById('productForm').reset();
            document.getElementById('previewBox').classList.add('hidden');
            
            if(id) {
                const p = products.find(x => x.id === id);
                document.getElementById('modalTitle').innerText = "EDITAR PRODUCTO";
                document.getElementById('editId').value = p.id;
                document.getElementById('name').value = p.name;
                document.getElementById('price').value = p.price;
                document.getElementById('comparePrice').value = p.comparePrice || '';
                document.getElementById('category').value = p.category;
                document.getElementById('description').value = p.description;
                document.getElementById('currentImageUrl').value = p.image || "";
                document.getElementById('isActive').checked = p.isActive !== false;
                document.getElementById('sizes').value = (p.sizes || ["S","M","L","XL"]).join(', ');
                
                if(p.image) {
                    document.getElementById('imgPreview').src = p.image;
                    document.getElementById('previewBox').classList.remove('hidden');
                }
            } else {
                document.getElementById('modalTitle').innerText = "NUEVO PRODUCTO";
                document.getElementById('editId').value = "";
                document.getElementById('isActive').checked = true;
                document.getElementById('sizes').value = "S, M, L, XL";
            }
            modalEl.classList.remove('hidden');
            setTimeout(() => modalContent.classList.remove('translate-x-full'), 10);
        }

        window.closeModal = () => {
            modalContent.classList.add('translate-x-full');
            setTimeout(() => modalEl.classList.add('hidden'), 300);
        }

        window.toggleActive = async (id, status) => {
            if(!confirm(`¿${status ? 'Activar' : 'Desactivar'} este producto?`)) return;
            await updateDoc(doc(db, "products", id), { isActive: status });
            loadProducts();
        }

        window.previewFile = () => {
            const f = document.getElementById('imageFile').files[0];
            if(f) {
                const r = new FileReader();
                r.onload = e => {
                    document.getElementById('imgPreview').src = e.target.result;
                    document.getElementById('previewBox').classList.remove('hidden');
                };
                r.readAsDataURL(f);
            }
        }

        // SUBIR A IMGBB
        async function uploadImageToImgBB(file) {
            const formData = new FormData();
            formData.append("image", file);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const json = await response.json();
            if (!json.success) throw new Error("Error ImgBB: " + (json.error ? json.error.message : "Desconocido"));
            return json.data.url;
        }

        // GUARDAR PRODUCTO
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveBtn');
            btn.disabled = true; 
            const originalText = btn.innerHTML;
            
            try {
                const id = document.getElementById('editId').value;
                const name = document.getElementById('name').value;
                const price = parseFloat(document.getElementById('price').value);
                const comparePrice = document.getElementById('comparePrice').value ? parseFloat(document.getElementById('comparePrice').value) : null;
                const category = document.getElementById('category').value;
                const description = document.getElementById('description').value;
                const isActive = document.getElementById('isActive').checked;
                const sizes = document.getElementById('sizes').value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
                const file = document.getElementById('imageFile').files[0];

                let image = document.getElementById('currentImageUrl').value;

                if(file) {
                    btn.innerHTML = `<i data-lucide="upload-cloud" class="animate-bounce"></i> SUBIENDO IMAGEN...`;
                    lucide.createIcons();
                    image = await uploadImageToImgBB(file);
                }

                btn.innerHTML = `<i data-lucide="database" class="animate-pulse"></i> GUARDANDO DATOS...`;
                lucide.createIcons();

                const data = { name, price, comparePrice, category, description, isActive, sizes, image, updatedAt: serverTimestamp() };

                if(id) await updateDoc(doc(db, "products", id), data);
                else { data.createdAt = serverTimestamp(); await addDoc(collection(db, "products"), data); }

                closeModal();
                loadProducts();
                alert("Guardado Exitosamente");

            } catch(err) {
                console.error(err);
                alert("Error: " + err.message);
            } finally {
                btn.disabled = false; 
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        });

        // VIEW ORDER
        window.viewOrder = (id) => {
            const o = orders.find(x => x.id === id);
            if(!o) return;
            
            const items = (o.items || []).map(i => `
                <div class="flex justify-between items-center border-b border-[#333] pb-2">
                    <div class="flex gap-3">
                        <img src="${i.image}" class="w-10 h-10 object-cover bg-[#222]">
                        <div><div class="text-white font-bold">${i.name}</div><div class="text-[10px] text-neutral-500">Talla: ${i.size} | x${i.qty}</div></div>
                    </div>
                    <div class="font-mono text-xs">C$ ${i.price * i.qty}</div>
                </div>
            `).join('');

            document.getElementById('orderDetailContent').innerHTML = `
                <div class="grid grid-cols-2 gap-4 bg-[#050505] p-3 border border-[#333]">
                    <div><span class="text-[10px] text-neutral-500 block">CLIENTE</span><span class="text-white font-bold">${o.customer.name}</span></div>
                    <div><span class="text-[10px] text-neutral-500 block">TELÉFONO</span><a href="https://wa.me/${o.customer.phone}" target="_blank" class="text-[#ccff00] hover:underline">${o.customer.phone}</a></div>
                </div>
                <div class="mt-4"><span class="text-[10px] text-neutral-500 block mb-1">DIRECCIÓN</span><p class="text-white bg-[#050505] p-2 border border-[#333]">${o.customer.detail}</p></div>
                ${o.destination ? `<div class="mt-2"><a href="https://maps.google.com/?q=${o.destination.lat},${o.destination.lng}" target="_blank" class="text-[#ff003c] text-xs flex items-center gap-1 font-bold"><i data-lucide="map-pin" width="12"></i> VER MAPA GPS</a></div>` : ''}
                <div class="mt-4 space-y-2">${items}</div>
                <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#333] font-bold text-white text-lg">
                    <span>TOTAL</span><span>C$ ${o.total}</span>
                </div>
            `;
            document.getElementById('orderModal').classList.remove('hidden');
            lucide.createIcons();
        }

        lucide.createIcons();
    </script>
</body>
</html>
