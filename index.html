<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kura Studio | Anime, Fan, Art</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Chakra+Petch:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">

    <!-- FIREBASE (V8 Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- REACT 18 (ORDEN CORREGIDO: React va antes de ReactDOM) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- LUCIDE ICONS -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --neon-red: #ff003c;
            --acid-green: #ccff00;
            --cyber-black: #050505;
            --panel-bg: #0a0a0a;
            --border-col: #222;
        }

        body { 
            font-family: 'Chakra Petch', sans-serif;
            background-color: var(--cyber-black); 
            color: #e5e5e5; 
            margin: 0; 
            overflow-x: hidden;
        }

        /* --- ANIMACIONES --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }

        /* --- UI UTILS --- */
        .btn-cyber {
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: all 0.2s;
        }
        .btn-cyber:hover { transform: translate(-2px, -2px); box-shadow: 4px 4px 0 var(--neon-red); }
        .btn-cyber:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .shop-input {
            width: 100%; background: #111; border: 1px solid #333; color: white; padding: 12px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; transition: border-color 0.3s;
        }
        .shop-input:focus { border-color: var(--neon-red); outline: none; }

        .toast-enter { transform: translateY(-20px); opacity: 0; }
        .toast-active { transform: translateY(0); opacity: 1; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-red); }
        
        /* Typography */
        .font-logo { font-family: 'Syncopate', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .jp-dynamic {
            writing-mode: vertical-rl;
            text-orientation: upright;
            font-size: 10px;
            font-weight: bold;
            color: var(--neon-red);
            letter-spacing: 3px;
            height: 40px;
            line-height: 1;
            animation: energy-pulse 2s infinite alternate;
            text-shadow: 0 0 5px var(--neon-red);
            margin-left: 10px;
        }
        @keyframes energy-pulse {
            0% { opacity: 0.8; text-shadow: 0 0 2px var(--neon-red); }
            100% { opacity: 1; text-shadow: 0 0 8px var(--neon-red); }
        }
        
        /* Marquee */
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-content { display: inline-block; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        /* Glitch */
        .glitch-text { position: relative; }
        .glitch-text::before, .glitch-text::after {
            content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--cyber-black);
        }
        .glitch-text::before {
            left: 2px; text-shadow: -1px 0 var(--neon-red); clip: rect(24px, 550px, 90px, 0); animation: glitch-anim 3s infinite linear alternate-reverse;
        }
        .glitch-text::after {
            left: -2px; text-shadow: -1px 0 var(--acid-green); clip: rect(85px, 550px, 140px, 0); animation: glitch-anim 2s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim {
            0% { clip: rect(13px, 9999px, 81px, 0); } 20% { clip: rect(98px, 9999px, 11px, 0); }
            40% { clip: rect(5px, 9999px, 66px, 0); } 60% { clip: rect(32px, 9999px, 88px, 0); }
            80% { clip: rect(76px, 9999px, 3px, 0); } 100% { clip: rect(10px, 9999px, 92px, 0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 0. MOCK DATA & CONFIG ---
        const MOCK_PRODUCTS = [
            { id: '1', name: 'UNIT-01 HOODIE', price: 1200, category: 'OUTERWEAR', image: 'https://images.unsplash.com/photo-1556905055-8f358a7a47b2?q=80&w=2070&auto=format&fit=crop', description: 'Sudadera oversize de alto gramaje.', variants: { S: 10, M: 5, L: 8, XL: 2 } },
            { id: '2', name: 'CYBER CARGO V2', price: 1800, category: 'BOTTOMS', image: 'https://images.unsplash.com/photo-1624378439575-d8705ad7ae80?q=80&w=1997&auto=format&fit=crop', description: 'Pantal贸n cargo t茅cnico.', variants: { XS: 0, S: 2, M: 10, L: 3 } },
        ];
        
        // La clave API de ImgBB debe ser proporcionada por el usuario si desea que la carga del comprobante funcione.
        const IMGBB_API_KEY = "b922654effe3a1ab5ac85cc4c23f97b8"; 

        const PHONE = "+50587091008";
        const BANK_ACCOUNT = "123456789"; 
        
        // --- CONFIGURACIN DE ENVO FIJO (Nuevo) ---
        const SHIPPING_RATES = {
            MANAGUA: 100,
            DEPARTAMENTO: 137,
        };

        const DEPARTMENTS = [
            "Managua", "Le贸n", "Chinandega", "Granada", "Masaya", "Carazo", 
            "Rivas", "Boaco", "Chontales", "Estel铆", "Jinotega", "Matagalpa", 
            "Madriz", "Nueva Segovia", "R铆o San Juan", "RAAN", "RAAS"
        ];
        
        const LAST_ORDER_KEY = 'kura_last_order'; // Clave para persistir la 煤ltima orden pendiente

        // --- NEW: Safe localStorage Wrapper to prevent SecurityError in sandboxed environments ---
        const safeStorage = {
            getItem: (key) => {
                try {
                    return window.localStorage.getItem(key);
                } catch (e) {
                    console.warn("Storage access denied for getItem:", e.message);
                    return null;
                }
            },
            setItem: (key, value) => {
                try {
                    window.localStorage.setItem(key, value);
                } catch (e) {
                    console.warn("Storage access denied for setItem:", e.message);
                }
            }
        };
        
        // Funci贸n para subir a ImgBB
        async function uploadImageToImgBB(file) {
            const formData = new FormData();
            formData.append("image", file);
            // Implementar l贸gica de reintento con backoff en una aplicaci贸n de producci贸n
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const json = await response.json();
            if (!json.success) throw new Error("Error ImgBB: " + (json.error ? json.error.message : "Desconocido"));
            return json.data.url;
        }

        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;

        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyAztg4F0twRi2NOP8MayAOUYB0ZtHgkss0",
            authDomain: "kodialabsnic.firebaseapp.com",
            databaseURL: "https://kodialabsnic-default-rtdb.firebaseio.com",
            projectId: "kodialabsnic",
            storageBucket: "kodialabsnic.firebasestorage.app",
            messagingSenderId: "740746852984",
            appId: "1:740746852984:web:972aa34592aef881630b8d"
        };

        let db, auth, isFirebaseActive = false;
        
        try {
            if (window.firebase) {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                isFirebaseActive = true;
                console.log("Firebase initialized successfully");
            }
        } catch (e) { 
            console.warn("FIREBASE FAILED TO INIT:", e.message); 
            isFirebaseActive = false;
        }

        // --- CORRECCIN CRTICA DE ICONOS LUCIDE/REACT ---
        const Icon = ({ name, size = 20, className }) => {
            const iRef = useRef(null);

            useEffect(() => { 
                if (iRef.current && window.lucide) {
                    // Llama al m茅todo global para transformar el <i> en SVG.
                    window.lucide.createIcons();
                }
                
                // Limpieza al desmontar el componente. ESTO ES CLAVE PARA EVITAR NotFoundError
                return () => {
                    if (iRef.current) {
                        iRef.current.innerHTML = '';
                    }
                };
            }, [name, size, className]);

            return <i ref={iRef} data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const formatPrice = (p) => typeof p === 'number' ? p.toFixed(2) : "0.00";

        // --- UI COMPONENTS ---
        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, type = "button" }) => {
            const baseClass = "btn-cyber font-mono font-bold uppercase tracking-widest px-8 py-4 flex items-center justify-center gap-3 text-sm";
            const variants = {
                primary: "bg-[#ff003c] text-white hover:bg-white hover:text-black",
                outline: "bg-transparent border border-neutral-600 text-white hover:border-[#ff003c] hover:text-[#ff003c]",
                acid: "bg-[#ccff00] text-black hover:bg-white",
                ghost: "bg-transparent text-neutral-500 hover:text-white"
            };
            return <button type={type} disabled={disabled} onClick={onClick} className={`${baseClass} ${variants[variant]} ${className}`}>{children}</button>;
        };

        const Toast = ({ show, message }) => (
            <div className={`fixed top-24 right-4 z-[999] bg-[#111] border-l-4 border-[#ff003c] p-4 shadow-2xl flex items-center gap-3 transition-all duration-300 ${show ? 'toast-active' : 'toast-enter opacity-0'}`}>
                <div className="bg-[#ff003c] rounded-full p-1 w-6 h-6 flex items-center justify-center"><Icon name="check" size={14} className="text-white"/></div>
                <span className="text-white font-mono text-xs font-bold uppercase tracking-widest">{message}</span>
            </div>
        );

        const CriticalErrorBanner = ({ error, onClose }) => {
            if (!error) return null;
            return (
                <div className="fixed inset-x-0 top-0 z-[10001] bg-red-800 text-white p-4 font-mono text-xs shadow-2xl animate-fade-in">
                    <div className="max-w-7xl mx-auto flex justify-between items-start">
                        <div className="flex items-start gap-4">
                            <Icon name="alert-triangle" size={24} className="text-yellow-400 mt-1 flex-shrink-0"/>
                            <div>
                                <h3 className="font-bold uppercase text-base text-yellow-300">ERROR CRTICO DEL SISTEMA</h3>
                                <p className="mt-1">**Mensaje t茅cnico:** {error}</p>
                            </div>
                        </div>
                        <button onClick={onClose} className="text-white hover:text-red-300 transition-colors"><Icon name="x" size={18}/></button>
                    </div>
                </div>
            );
        };

        const Marquee = () => (
            <div className="bg-[#ff003c] text-black font-bold font-mono text-xs py-1 border-b border-[#ff003c] marquee-container select-none">
                <div className="marquee-content">
                    <span className="mx-4">ENVOS A TODA NICARAGUA </span><span className="mx-4">///</span>
                    <span className="mx-4">ENVOS A TODA NICARAGUA</span><span className="mx-4">///</span>
                    <span className="mx-4">ENVOS A TODA NICARAGUA</span><span className="mx-4">///</span>
                    <span className="mx-4">ENVOS A TODA NICARAGUA</span><span className="mx-4">///</span>
                </div>
            </div>
        );

        // --- HERO COMPONENT ---
        const Hero = ({ products }) => {
            const [index, setIndex] = useState(0);
            
            const images = useMemo(() => {
                return products.filter(p => p.image).map(p => p.image).slice(0, 4);
            }, [products]);

            useEffect(() => {
                if (images.length <= 1) return;
                const t = setInterval(() => setIndex(prev => (prev + 1) % images.length), 4000);
                return () => clearInterval(t);
            }, [images]);

            const scrollToShop = () => {
                const shopEl = document.getElementById('shop');
                if(shopEl) shopEl.scrollIntoView({behavior: 'smooth'});
            };

            return (
                <div className="relative h-[85vh] w-full bg-black overflow-hidden flex items-center justify-center border-b border-[#222]">
                    {images.length > 0 ? images.map((img, i) => (
                        <div key={i} className={`absolute inset-0 bg-cover bg-center transition-opacity duration-1000 ${i === index ? 'opacity-60' : 'opacity-0'}`} style={{backgroundImage: `url('${img}')`}}></div>
                    )) : (
                        <div className="absolute inset-0 bg-[#050505]"></div> 
                    )}

                    <div className="absolute inset-0 bg-gradient-to-t from-[#050505] via-transparent to-black/30"></div>
                    <div className="absolute inset-0 pointer-events-none" style={{backgroundImage: 'linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px)', backgroundSize: '50px 50px'}}></div>

                    <div className="relative z-10 text-center px-4">
                        <div className="inline-block border border-[#ff003c] px-3 py-1 mb-6 bg-black/60 backdrop-blur-sm animate-fade-in">
                            <span className="text-[#ff003c] text-[10px] font-bold tracking-[0.4em] uppercase">COLLECTION 2026</span>
                        </div>
                        <h1 className="text-5xl md:text-8xl font-black font-logo uppercase text-white mb-8 tracking-tighter glitch-text animate-fade-in" data-text="ANIME CULTURE">
                            ANIME<br/>CULTURE
                        </h1>
                        <div className="mt-8 flex justify-center animate-slide-up">
                            <Button onClick={scrollToShop} className="mx-auto">VER DROPS</Button>
                        </div>
                    </div>
                </div>
            );
        };

        const SizeTable = ({ onClose }) => (
            <div className="fixed inset-0 z-[10000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                <div className="bg-[#111] border border-[#ff003c] w-full max-w-lg relative p-0 overflow-hidden shadow-[0_0_50px_rgba(255,0,60,0.1)] animate-slide-up" onClick={e => e.stopPropagation()}>
                    <div className="bg-[#0a0a0a] border-b border-[#333] p-4 flex justify-between items-center">
                         <h3 className="text-[#ff003c] font-bold uppercase tracking-widest text-sm flex items-center gap-2"><Icon name="ruler" size={16}/> GUA DE TALLAS (CM)</h3>
                         <button onClick={onClose} className="text-neutral-400 hover:text-white"><Icon name="x" size={20}/></button>
                    </div>
                    <div className="overflow-x-auto p-4 max-h-[60vh] overflow-y-auto">
                        <table className="w-full text-center text-xs font-mono text-neutral-400 border-collapse">
                            <thead className="text-white font-bold bg-[#1a1a1a]">
                                <tr>
                                    <th className="p-3 border border-[#333] text-left">MEDIDA</th>
                                    <th className="p-3 border border-[#333]">XS</th>
                                    <th className="p-3 border border-[#333]">S</th>
                                    <th className="p-3 border border-[#333]">M</th>
                                    <th class="p-3 border border-[#333]">L</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-[#222]">
                                <tr><td className="p-3 border border-[#333] text-left font-bold text-white">Pecho</td><td className="border border-[#333]">42</td><td class="border border-[#333]">47</td><td class="border border-[#333]">52</td><td class="border border-[#333]">58</td></tr>
                                <tr><td class="p-3 border border-[#333] text-left font-bold text-white">Largo</td><td class="border border-[#333]">69</td><td class="border border-[#333]">70</td><td class="border border-[#333]">73.5</td><td class="border border-[#333]">76</td></tr>
                                <tr><td class="p-3 border border-[#333] text-left font-bold text-white">Manga</td><td class="border border-[#333]">20</td><td class="border border-[#333]">21</td><td class="border border-[#333]">22</td><td class="border border-[#333]">23</td></tr>
                            </tbody>
                        </table>
                        <p class="text-[10px] text-neutral-500 mt-4 text-center font-mono">* Las medidas pueden variar +/- 1cm.</p>
                    </div>
                    <div class="p-4 border-t border-[#222] bg-[#0a0a0a]">
                        <Button onClick={onClose} variant="outline" className="w-full py-3 text-xs">ENTENDIDO</Button>
                    </div>
                </div>
            </div>
        );

        // 2. MEJORA VISTA DE DETALLE (Con soporte para tallas y ofertas de Admin)
        const ProductDetail = ({ product, onBack, onAdd }) => {
            // Usa el campo 'variants' para determinar las tallas disponibles
            const sizeOptions = product.variants ? Object.keys(product.variants) : ['S','M','L','XL'];
            const [size, setSize] = useState(sizeOptions[0]);
            const [qty, setQty] = useState(1);
            const [showTable, setShowTable] = useState(false);
            const hasDiscount = product.comparePrice && product.comparePrice > product.price;

            return (
                <div className="min-h-screen pt-24 pb-20 px-4 container mx-auto animate-fade-in relative max-w-6xl">
                    {showTable && <SizeTable onClose={() => setShowTable(false)} />}
                    
                    <button onClick={onBack} className="fixed top-24 left-4 z-40 bg-black/50 backdrop-blur px-4 py-2 rounded-full border border-[#333] flex items-center gap-2 text-white hover:text-[#ff003c] hover:border-[#ff003c] font-mono text-xs font-bold uppercase tracking-widest transition-all">
                        <Icon name="arrow-left" size={14}/> VOLVER
                    </button>

                    <div className="grid lg:grid-cols-2 gap-8 lg:gap-16 mt-8">
                        {/* IMAGEN GRANDE Y MEJORADA */}
                        <div className="bg-black border border-[#222] relative group w-full aspect-[3/4] lg:aspect-auto lg:h-[80vh] overflow-hidden">
                            <img 
                                src={product.image} 
                                className="w-full h-full object-cover object-top transition-transform duration-700 group-hover:scale-105"
                            />
                            {hasDiscount && <div className="absolute top-4 right-4 bg-[#ccff00] text-black text-xs font-bold px-3 py-1 uppercase rounded-sm">OFERTA</div>}
                        </div>

                        <div className="flex flex-col justify-center space-y-6">
                            <div>
                                <h2 className="text-[#ff003c] font-mono text-xs font-bold tracking-[0.2em] mb-2 flex items-center gap-2"><div className="w-4 h-[1px] bg-[#ff003c]"></div>{product.category}</h2>
                                <h1 className="text-4xl md:text-6xl font-black font-logo text-white uppercase leading-none">{product.name}</h1>
                            </div>
                            
                            <div className="flex items-center gap-4 border-y border-[#222] py-4">
                                <div className="text-3xl font-mono font-bold text-[#ccff00]">C$ {formatPrice(product.price)}</div>
                                {hasDiscount && <div className="text-xl font-mono font-bold text-neutral-500 line-through">C$ {formatPrice(product.comparePrice)}</div>}
                                <div className="text-neutral-500 text-xs font-mono uppercase ml-auto">IVA INCLUIDO</div>
                            </div>
                            
                            <p className="text-neutral-300 text-sm md:text-base leading-relaxed font-light">{product.description}</p>
                            
                            <div className="space-y-6 bg-[#0f0f0f] p-4 rounded-sm border border-[#222]">
                                {/* Selector de Talla */}
                                <div>
                                    <div className="flex justify-between items-center mb-3">
                                        <span className="text-xs font-bold text-white font-mono uppercase flex items-center gap-2"><Icon name="shirt" size={14}/> SELECCIONAR TALLA</span>
                                        <button onClick={() => setShowTable(true)} className="text-[10px] text-[#ff003c] underline font-mono font-bold uppercase hover:text-white">GUA DE TALLAS</button>
                                    </div>
                                    <div className="grid grid-cols-4 gap-2">
                                        {sizeOptions.map(s => {
                                            const stock = product.variants ? (product.variants[s] || 0) : 1;
                                            const isOutOfStock = stock <= 0;
                                            return (
                                                <button key={s} 
                                                    onClick={() => setSize(s)} 
                                                    disabled={isOutOfStock}
                                                    className={`h-12 border flex items-center justify-center font-mono font-bold text-sm transition-all relative overflow-hidden ${size===s && !isOutOfStock ? 'bg-white text-black border-white' : isOutOfStock ? 'bg-red-900/20 border-red-900 text-red-500 opacity-50' : 'bg-[#050505] border-[#333] text-neutral-500 hover:border-[#ff003c] hover:text-[#ff003c]'}`}
                                                >
                                                    {s}
                                                    {isOutOfStock && <span className="absolute text-[8px] bottom-0 w-full bg-red-800 text-white font-mono uppercase">AGOTADO</span>}
                                                    {size===s && !isOutOfStock && <div className="absolute bottom-0 right-0 w-2 h-2 bg-[#ff003c]"></div>}
                                                </button>
                                            );
                                        })}
                                    </div>
                                    {size && product.variants && product.variants[size] === 0 && (
                                        <p className="text-xs text-red-500 font-mono mt-2 text-center">隆Agotado en talla {size}!</p>
                                    )}
                                </div>
                                
                                {/* Cantidad */}
                                <div>
                                    <span className="block text-xs font-bold text-white font-mono uppercase mb-3">CANTIDAD</span>
                                    <div className="flex items-center justify-between bg-[#050505] border border-[#333] p-1">
                                        <button onClick={() => setQty(Math.max(1, qty - 1))} className="w-12 h-10 hover:bg-[#222] text-white flex items-center justify-center transition-colors"><Icon name="minus" size={16}/></button>
                                        <span className="font-mono font-bold text-lg text-white w-12 text-center">{qty}</span>
                                        <button onClick={() => setQty(qty + 1)} className="w-12 h-10 hover:bg-[#222] text-white flex items-center justify-center transition-colors"><Icon name="plus" size={16}/></button>
                                    </div>
                                </div>
                            </div>
                            
                            <Button 
                                onClick={() => onAdd(product, size, qty)} 
                                variant="acid" 
                                className="w-full text-lg py-5 shadow-[0_0_20px_rgba(204,255,0,0.2)]"
                                disabled={!size || (product.variants && (product.variants[size] || 0) <= 0)}
                            >
                                AADIR AL CARRITO - C$ {formatPrice(product.price * qty)}
                            </Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- NEW: CONFIRMATION SCREEN COMPONENT (PERSISTENT STEP) ---
        const OrderConfirmationScreen = ({ orderData, onConfirmFinish, setCriticalError }) => {
            const { orderId, total, paymentMethod, customer, needsReceipt, receiptUrl: initialReceiptUrl } = orderData;
            
            const [receiptImageURL, setReceiptImageURL] = useState(initialReceiptUrl);
            const [isUploadingReceipt, setIsUploadingReceipt] = useState(false);
            const [copied, setCopied] = useState(false);

            // Function to handle receipt upload (updates local storage with new URL)
            const handleReceiptUpload = async (file) => {
                if (!file) return;

                setIsUploadingReceipt(true);
                try {
                    const url = await uploadImageToImgBB(file);
                    setReceiptImageURL(url);
                    
                    // Update Local Storage with the new URL
                    const updatedOrderData = { ...orderData, receiptUrl: url };
                    safeStorage.setItem(LAST_ORDER_KEY, JSON.stringify(updatedOrderData));
                    
                    console.log("Comprobante subido exitosamente: " + url); 
                } catch (error) {
                    console.error("Error subiendo comprobante:", error);
                    setCriticalError("Error al subir comprobante. Int茅ntalo de nuevo. " + error.message);
                } finally {
                    setIsUploadingReceipt(false);
                }
            };
            
            const copyToClipboard = () => {
                const tempElement = document.createElement('textarea');
                tempElement.value = BANK_ACCOUNT;
                document.body.appendChild(tempElement);
                tempElement.select();
                document.execCommand('copy');
                document.body.removeChild(tempElement);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };
            
            // This is the final client action: clears persistence and returns home
            const handleFinishAndClear = () => {
                // Here, you would typically make a Firestore call to update the order status
                // e.g., 'payment_confirmed_client' if receipt is attached.
                
                // Then, clear persistence and go home.
                onConfirmFinish(); 
            };

            return (
                <div className="min-h-screen pt-32 px-4 flex items-center justify-center pb-20 animate-fade-in">
                    <div className="max-w-md w-full bg-[#111] border border-[#ff003c] p-8 text-center relative shadow-[0_0_50px_rgba(255,0,60,0.1)] animate-slide-up">
                        <div className="w-16 h-16 bg-[#ff003c] rounded-full flex items-center justify-center mx-auto mb-6 shadow-[0_0_20px_#ff003c] animate-bounce">
                            <Icon name="check" size={32} className="text-white"/>
                        </div>
                        <h2 className="text-2xl font-black font-logo uppercase mb-2">ORDEN PENDIENTE DE PAGO</h2>
                        <p className="text-[#ff003c] font-mono text-xl font-bold mb-6">{orderId}</p>

                        <div className="bg-[#0a0a0a] border border-[#333] p-6 mb-8 rounded text-left">
                            <p className="text-neutral-400 text-xs font-mono mb-4 uppercase tracking-widest text-center">TOTAL: <span className="text-[#ccff00] font-bold">C$ {formatPrice(total)}</span></p>
                            <p className="text-neutral-400 text-xs font-mono mb-4 uppercase tracking-widest text-center">MTODO: <span className="text-white font-bold">{paymentMethod}</span></p>
                            
                            {paymentMethod === 'Kash' && (
                                <div className="flex flex-col items-center animate-fade-in">
                                    <p className="text-white text-xs font-bold mb-3 uppercase">Escanea QR Kash</p>
                                    <div className="bg-white p-2 w-32 h-32 rounded shadow-lg mb-4 flex items-center justify-center text-xs text-black">QR Placeholder</div>
                                </div>
                            )}
                            {paymentMethod === 'Transferencia' && (
                                <div className="animate-fade-in text-center">
                                    <p className="text-neutral-500 text-[10px] uppercase mb-1">CUENTA BAC (C贸rdobas)</p>
                                    <div className="text-xl text-[#ccff00] font-mono font-bold mb-4 bg-black/50 p-2 border border-[#333] rounded">{BANK_ACCOUNT}</div>
                                    <Button onClick={copyToClipboard} variant="outline" className="w-full py-2 text-xs h-10 border-neutral-700">{copied ? "COPIADO" : "COPIAR CUENTA"}</Button>
                                </div>
                            )}
                            
                            {needsReceipt && (
                                <div className="mt-6 border-t border-[#333] pt-4 animate-slide-up">
                                    <label className="text-xs font-bold text-[#ccff00] font-mono uppercase mb-2 block">CARGA TU COMPROBANTE</label>
                                    <input 
                                        type="file" 
                                        accept="image/*" 
                                        onChange={(e) => handleReceiptUpload(e.target.files[0])} 
                                        className="shop-input text-xs p-2 border-[#ccff00]/30"
                                        disabled={isUploadingReceipt}
                                    />
                                    {isUploadingReceipt && <p className="text-xs text-[#ccff00] mt-2 flex items-center gap-2"><Icon name="loader-2" className="animate-spin" size={12}/> Subiendo archivo...</p>}
                                    {receiptImageURL && (
                                        <div className="mt-3 p-2 bg-[#111] border border-[#222] relative">
                                            <p className="text-[10px] text-white font-mono mb-2">Comprobante Cargado:</p>
                                            <img src={receiptImageURL} alt="Comprobante de Pago" className="w-full h-auto max-h-32 object-contain border border-[#ccff00]"/>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        
                        <Button onClick={handleFinishAndClear} className="w-full mb-4" disabled={needsReceipt && !receiptImageURL}>
                            {needsReceipt ? "CONFIRMAR PAGO Y FINALIZAR" : "CONFIRMAR PEDIDO (PAGO EN EFECTIVO)"}
                        </Button>
                        
                        <a href={`https://wa.me/${PHONE}?text=${encodeURIComponent(` *PEDIDO ${orderId}* \n\n*Cliente:* ${customer.name}\n*Tel茅fono:* ${customer.phone}\n*Direcci贸n:* ${customer.address}, ${customer.neighborhood}, ${customer.department}\n*Total:* C$ ${formatPrice(total)}\n*MTODO:* ${paymentMethod}`)}`} 
                            target="_blank" 
                            className="w-full mb-4 inline-flex items-center justify-center btn-cyber font-mono font-bold uppercase tracking-widest px-8 py-4 text-sm bg-green-600 text-white hover:bg-green-700 gap-3"
                        >
                            ENVIAR A WHATSAPP
                        </a>
                        
                        <Button onClick={onConfirmFinish} variant="outline" className="w-full">VOLVER A TIENDA</Button>
                    </div>
                </div>
            );
        }

        // 3. CHECKOUT SIMPLIFICADO Y LGICA DE STOCK (REQUERIDO)
        const SmartCheckout = ({ cart, subtotal, onBack, setCriticalError, setPersistentOrder, setView }) => {
            const [step, setStep] = useState(1);
            const [shippingCost, setShippingCost] = useState(0);
            const [formData, setFormData] = useState({ 
                name: '', phone: '', address: '', neighborhood: '', department: DEPARTMENTS[0]
            });
            const [paymentMethod, setPaymentMethod] = useState(''); 
            const [cashAmount, setCashAmount] = useState('');
            const [stockError, setStockError] = useState(null); 
            const [isProcessing, setIsProcessing] = useState(false);

            const total = subtotal + shippingCost;
            
            // Efecto para calcular el costo de env铆o basado en el departamento
            useEffect(() => {
                const cost = formData.department === "Managua" 
                    ? SHIPPING_RATES.MANAGUA 
                    : SHIPPING_RATES.DEPARTAMENTO;
                setShippingCost(cost);
            }, [formData.department]);
            
            const confirmOrder = async () => {
                if (isProcessing) return;
                setIsProcessing(true);
                setStockError(null);

                // 1. Crear ID
                const newId = `ORD-${Date.now().toString().slice(-6)}`;
                
                // Determinar si necesita comprobante
                const needsReceipt = paymentMethod === 'Transferencia' || paymentMethod === 'Kash';
                
                // Estado inicial
                let initialStatus = needsReceipt ? 'pending_payment' : 'pending_delivery'; 
                
                // 2. Iniciar Transacci贸n (CRTICO: Descuento de Stock)
                if (isFirebaseActive && db) {
                    try {
                        await db.runTransaction(async (transaction) => {
                            // a) Verificar stock y preparar updates
                            for (const item of cart) {
                                const productRef = db.collection('products').doc(item.id);
                                const productDoc = await transaction.get(productRef);

                                if (!productDoc.exists) {
                                    throw new Error(`PRODUCT_NOT_FOUND: El art铆culo ${item.name} no existe.`);
                                }

                                const currentVariants = productDoc.data().variants || {};
                                const currentStock = currentVariants[item.size] || 0;
                                
                                // OJO: Si no existe la variante, currentStock es 0.
                                if (currentStock < item.qty) {
                                    // Stock insuficiente, abortar transacci贸n
                                    throw new Error(`STOCK_ERROR: Solo quedan ${currentStock} de ${item.name} (${item.size}).`);
                                }

                                // b) Descontar stock
                                const newStock = currentStock - item.qty;
                                transaction.update(productRef, {
                                    [`variants.${item.size}`]: newStock
                                });
                            }

                            // c) Registrar la Orden (Solo si el stock es suficiente)
                            const orderData = {
                                orderId: newId,
                                date: firebase.firestore.FieldValue.serverTimestamp(),
                                customer: {
                                    name: formData.name,
                                    phone: formData.phone,
                                    detail: `${formData.address}, ${formData.neighborhood}, ${formData.department}`
                                },
                                items: cart,
                                subtotal: subtotal,
                                shipping: shippingCost,
                                total: total,
                                paymentMethod: paymentMethod,
                                cashAmount: cashAmount || null,
                                status: initialStatus,
                                receiptUrl: null,
                                address: {
                                    department: formData.department,
                                    address: formData.address,
                                    neighborhood: formData.neighborhood,
                                }
                            };
                            await db.collection('orders').add(orderData);
                        });

                        // Transacci贸n exitosa
                        console.log("Orden y stock actualizados correctamente. Preparando persistencia.");

                        // --- PERSISTENCE & VIEW CHANGE ON SUCCESS ---
                        const orderDataToSave = {
                            orderId: newId,
                            total: total,
                            paymentMethod: paymentMethod,
                            customer: formData,
                            needsReceipt: needsReceipt,
                            receiptUrl: null,
                        };

                        safeStorage.setItem(LAST_ORDER_KEY, JSON.stringify(orderDataToSave));
                        setPersistentOrder(orderDataToSave); // Actualiza App state
                        setView('confirmation'); // Navega a la vista persistente
                        // Limpiamos el carrito (ya se inici贸 la orden)

                    } catch (error) {
                        console.error("Error al procesar la orden o stock:", error);
                        // Mostrar el error de stock al usuario
                        if (error.message.startsWith('STOCK_ERROR')) {
                            setStockError(error.message.replace('STOCK_ERROR: ', ''));
                        } else {
                            setCriticalError("Error al guardar la orden. Int茅ntalo de nuevo. Error: " + error.message);
                        }
                    } finally {
                        setIsProcessing(false);
                    }
                } else {
                    // Si Firebase no est谩 activo (mock testing)
                    const needsReceiptMock = paymentMethod === 'Transferencia' || paymentMethod === 'Kash';
                    const orderDataToSave = {
                        orderId: newId,
                        total: total,
                        paymentMethod: paymentMethod,
                        customer: formData,
                        needsReceipt: needsReceiptMock,
                        receiptUrl: null,
                    };
                    safeStorage.setItem(LAST_ORDER_KEY, JSON.stringify(orderDataToSave));
                    setPersistentOrder(orderDataToSave);
                    setView('confirmation');
                    setIsProcessing(false);
                }
            };

            const isFormValid = formData.name && formData.phone.length >= 8 && formData.address && formData.neighborhood && formData.department;
            const isPaymentValid = paymentMethod;
            const isReadyToConfirm = isFormValid && isPaymentValid && !isProcessing;
            
            // NOTA: El paso 4 (Confirmation) se ha movido al componente OrderConfirmationScreen

            return (
                <div className="min-h-screen pt-32 pb-12 px-4 bg-[#020202] animate-fade-in">
                    <div className="max-w-7xl mx-auto grid lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-8 space-y-8">
                            <div className="flex justify-between items-center mb-6">
                                <h1 className="text-3xl font-black font-logo text-white">CHECKOUT</h1>
                                <button onClick={onBack} className="text-neutral-500 flex items-center gap-2 text-xs font-bold uppercase hover:text-[#ff003c]"><Icon name="x" size={14}/> CANCELAR</button>
                            </div>
                            
                            {/* PASO 1: DATOS DE ENVO */}
                            <div className={`bg-[#0a0a0a] border transition-all duration-300 overflow-hidden relative ${step === 1 ? 'border-[#ff003c] shadow-[0_0_30px_rgba(255,0,60,0.15)] ring-1 ring-[#ff003c]' : 'border-[#333] opacity-60'}`}>
                                <div className="p-4 bg-[#111] border-b border-[#222] flex justify-between items-center">
                                    <h3 className="text-sm font-bold uppercase tracking-widest text-white flex items-center gap-3"><span className="bg-[#ff003c] text-white w-6 h-6 flex items-center justify-center font-mono text-xs">1</span> DATOS DE ENVO Y CONTACTO</h3>
                                    {step > 1 && <button onClick={() => { setStep(1); setStockError(null); }} className="text-[10px] text-[#ccff00] font-bold uppercase hover:underline">EDITAR</button>}
                                </div>
                                
                                {step === 1 && (
                                    <div className="p-6 space-y-4 animate-fade-in">
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div className="space-y-1"><label className="text-[10px] text-neutral-500 font-bold uppercase">NOMBRE COMPLETO</label><input className="shop-input" value={formData.name} onChange={e=>setFormData({...formData, name:e.target.value})} /></div>
                                            <div className="space-y-1"><label className="text-[10px] text-neutral-500 font-bold uppercase">WHATSAPP</label><input className="shop-input" maxLength={8} placeholder="Ej: 88554477" value={formData.phone} onChange={e=>setFormData({...formData, phone:e.target.value.replace(/\D/g,'')})} /></div>
                                        </div>
                                        
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div className="space-y-1">
                                                <label className="text-[10px] text-neutral-500 font-bold uppercase">DEPARTAMENTO</label>
                                                <select className="shop-input" value={formData.department} onChange={e=>setFormData({...formData, department:e.target.value})}>
                                                    {DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}
                                                </select>
                                            </div>
                                            <div className="space-y-1"><label className="text-[10px] text-neutral-500 font-bold uppercase">BARRIO / COLONIA / RESIDENCIAL</label><input className="shop-input" value={formData.neighborhood} onChange={e=>setFormData({...formData, neighborhood:e.target.value})} /></div>
                                        </div>
                                        
                                        <div className="space-y-1"><label className="text-[10px] text-neutral-500 font-bold uppercase">DIRECCIN EXACTA (CASA, SEAS, REFERENCIA)</label><textarea className="shop-input" rows="3" value={formData.address} onChange={e=>setFormData({...formData, address:e.target.value})} /></div>
                                        
                                        <div className="flex justify-end pt-4">
                                            <Button disabled={!isFormValid} onClick={() => setStep(2)}>CONTINUAR <Icon name="arrow-right" size={16}/></Button>
                                        </div>
                                    </div>
                                )}
                                {step > 1 && <div className="p-4 bg-[#0a0a0a] flex items-center gap-3 text-xs text-neutral-400 border-t border-[#222]"><Icon name="check" size={14} className="text-[#ccff00]"/> {formData.address}, {formData.department}</div>}
                            </div>

                            {/* PASO 2: MTODO DE PAGO */}
                            <div className={`bg-[#0a0a0a] border transition-all duration-300 ${step === 2 ? 'border-[#ff003c] shadow-[0_0_30px_rgba(255,0,60,0.15)] ring-1 ring-[#ff003c]' : 'border-[#333] opacity-60'}`}>
                                <div className="p-4 bg-[#111] border-b border-[#222] flex justify-between items-center">
                                    <h3 className="text-sm font-bold uppercase tracking-widest text-white flex items-center gap-3"><span className={`w-6 h-6 flex items-center justify-center font-mono text-xs ${step===2 ? 'bg-[#ff003c] text-white' : 'bg-[#333] text-neutral-500'}`}>2</span> MTODO DE PAGO</h3>
                                    {step > 2 && <button onClick={() => { setStep(2); setStockError(null); }} className="text-[10px] text-[#ccff00] font-bold uppercase hover:underline">EDITAR</button>}
                                </div>
                                {step === 2 && (
                                    <div className="p-6 animate-fade-in">
                                        <div className="grid grid-cols-3 gap-4 mb-6">
                                            {['Transferencia', 'Efectivo', 'Kash'].map(m => (
                                                <button key={m} onClick={()=>setPaymentMethod(m)} className={`p-4 border text-xs font-bold uppercase transition-all h-24 flex flex-col items-center justify-center gap-2 ${paymentMethod===m ? 'border-[#ff003c] bg-[#ff003c]/10 text-white' : 'border-[#333] text-neutral-500 hover:border-white hover:bg-[#111]'}`}>
                                                    <Icon name={m==='Efectivo' ? 'banknote' : m==='Transferencia' ? 'credit-card' : 'smartphone'} size={20}/>
                                                    {m}
                                                </button>
                                            ))}
                                        </div>
                                        {paymentMethod === 'Efectivo' && (
                                            <div className="animate-slide-up bg-[#111] p-4 border border-[#333]">
                                                <label className="text-[10px] text-[#ccff00] font-bold uppercase mb-2 block">驴Con cu谩nto vas a pagar? (Para el cambio)</label>
                                                <input className="shop-input" placeholder="Ej: 500, 1000..." value={cashAmount} onChange={e => setCashAmount(e.target.value)} />
                                            </div>
                                        )}
                                        {stockError && (
                                            <div className="mt-4 p-3 bg-red-900/50 border border-red-700 text-red-300 text-xs font-mono">
                                                <Icon name="alert-triangle" size={14} className="inline mr-2"/>
                                                {stockError}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="lg:col-span-4">
                            <div className="bg-[#0a0a0a] border border-[#222] sticky top-24 shadow-2xl">
                                <div className="p-4 bg-[#111] border-b border-[#222]"><h3 className="text-sm font-bold uppercase tracking-widest text-white">RESUMEN DE ORDEN</h3></div>
                                <div className="p-6">
                                    <div className="space-y-4 mb-6 max-h-60 overflow-y-auto custom-scrollbar">
                                        {cart.map((i, idx) => (
                                            <div key={idx} className="flex gap-4 items-center">
                                                <div className="w-12 h-16 bg-[#111] border border-[#333]"><img src={i.image} className="w-full h-full object-cover"/></div>
                                                <div className="flex-1"><h4 className="font-bold text-white text-sm line-clamp-1">{i.name}</h4><p className="text-[9px] text-neutral-500">TALLA {i.size} / x{i.qty}</p></div>
                                                <p className="text-xs font-mono text-white">C$ {formatPrice(i.price * i.qty)}</p>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    <div className="space-y-2 text-xs font-mono text-neutral-400 border-t border-[#333] pt-4">
                                        <div className="flex justify-between"><span>SUBTOTAL</span><span>C$ {formatPrice(subtotal)}</span></div>
                                        <div className="flex justify-between items-center">
                                            <span className="flex items-center gap-1"><Icon name="truck" size={12}/> ENVO ({formData.department})</span>
                                            
                                            <span className={shippingCost > 0 ? 'text-[#ccff00]' : ''}>
                                                C$ {formatPrice(shippingCost)}
                                            </span>
                                        </div>
                                    </div>

                                    <div className="flex justify-between text-white font-bold text-xl pt-6 border-t border-[#333] mt-4 mb-6">
                                        <span>TOTAL</span><span>C$ {formatPrice(total)}</span>
                                    </div>

                                    <Button 
                                        disabled={!isReadyToConfirm}
                                        onClick={confirmOrder} 
                                        className="w-full text-sm py-5"
                                    >
                                        {isProcessing ? <><Icon name="loader-2" className="animate-spin"/> PROCESANDO...</> : "FINALIZAR PEDIDO"}
                                    </Button>
                                    
                                    <p className="text-[9px] text-center text-neutral-600 mt-4 font-mono uppercase">Env铆os calculados a zonas centricas de Nicaragua.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('home');
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState([]);
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [isCartOpen, setIsCartOpen] = useState(false);
            const [toast, setToast] = useState({ show: false, msg: '' });
            const [criticalError, setCriticalError] = useState(null); 
            const [persistentOrder, setPersistentOrder] = useState(null); // Nuevo: Estado para la orden persistente

            // Funci贸n para limpiar la orden persistente y el carrito
            const clearPersistentOrder = () => {
                safeStorage.setItem(LAST_ORDER_KEY, '');
                setPersistentOrder(null);
                setCart([]); // Limpiamos el carrito al finalizar el proceso
                setView('home');
            };

            useEffect(() => {
                const loadData = async () => {
                    let loadedProducts = MOCK_PRODUCTS;

                    if (isFirebaseActive && db) {
                        try {
                            const snap = await db.collection('products').orderBy('createdAt', 'desc').get();
                            if (!snap.empty) {
                                loadedProducts = snap.docs.map(d => {
                                    const data = d.data();
                                    return {
                                        id: d.id,
                                        ...data,
                                        variants: data.variants && typeof data.variants === 'object' ? data.variants : { S: 5, M: 5, L: 5 }
                                    };
                                }).filter(p => p.isActive !== false);
                            } else { 
                                console.warn("Firestore vac铆o, usando datos MOCK.");
                            }
                        } catch (e) { 
                            console.error("Error cargando productos desde Firestore:", e);
                            setCriticalError("Error al cargar productos de la base de datos.");
                        }
                    }
                    
                    setProducts(loadedProducts);
                
                    // 1. Cargar Cart
                    const savedCart = safeStorage.getItem('kura_cart');
                    if (savedCart) setCart(JSON.parse(savedCart));

                    // 2. Cargar Orden Persistente (CRTICO)
                    const savedOrder = safeStorage.getItem(LAST_ORDER_KEY);
                    if (savedOrder) {
                        try {
                            const parsedOrder = JSON.parse(savedOrder);
                            setPersistentOrder(parsedOrder);
                            // Si hay una orden pendiente, forzar la vista de confirmaci贸n
                            setView('confirmation'); 
                        } catch (e) {
                            safeStorage.setItem(LAST_ORDER_KEY, ''); // Limpiar si hay datos corruptos
                            console.error("Error al cargar orden persistente:", e);
                        }
                    }

                    // Llamada inicial de iconos
                    if (window.lucide) window.lucide.createIcons(); 
                };
                
                loadData();
            }, []);

            useEffect(() => { 
                // Guardar el carrito solo si NO estamos en la vista de confirmaci贸n
                // (la orden ya se proces贸 y el carrito debe limpiarse en `clearPersistentOrder`)
                if (view !== 'confirmation') {
                    safeStorage.setItem('kura_cart', JSON.stringify(cart)); 
                }
            }, [cart, view]);

            useEffect(() => { 
                window.scrollTo(0,0);
            }, [view, isCartOpen]);


            const showToast = (msg) => {
                setToast({ show: true, msg });
                setTimeout(() => setToast({ show: false, msg: '' }), 3000);
            };

            const addToCart = (product, size, qty) => {
                setCart(prev => {
                    const exists = prev.find(i => i.id === product.id && i.size === size);
                    if (exists) return prev.map(i => i.id === product.id && i.size === size ? { ...i, qty: i.qty + qty } : i);
                    return [...prev, { ...product, size, qty }];
                });
                showToast(`${qty}x ${product.name} AGREGADO`);
            };

            const removeFromCart = (index) => setCart(cart.filter((_, i) => i !== index));
            
            // FUNCIN: LIMPIAR TODO
            const clearCart = () => setCart([]);

            const cartTotal = cart.reduce((acc, item) => acc + (Number(item.price) * item.qty), 0);

            const CartDrawer = ({ isOpen, onClose, cart, remove, clearCart, onCheckout }) => {
                if (!isOpen) return null;
                const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
                return (
                    <div className="fixed inset-0 z-[100] flex justify-end">
                        <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
                        <div className="relative w-full max-w-md bg-[#050505] border-l border-[#222] h-full flex flex-col shadow-2xl animate-fade-in">
                            <div className="p-6 border-b border-[#222] flex justify-between items-center bg-[#0a0a0a]">
                                <h2 className="font-logo font-bold text-xl uppercase text-white">CARRITO ({cart.length})</h2>
                                <div className="flex gap-4 items-center">
                                    {cart.length > 0 && <button onClick={clearCart} className="text-[10px] text-[#ccff00] font-bold border border-[#ccff00] px-2 py-1 hover:bg-[#ccff00] hover:text-black transition">LIMPIAR</button>}
                                    <button onClick={onClose} className="hover:text-[#ff003c] transition-colors"><Icon name="x" size={24}/></button>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-6 space-y-6">
                                {cart.length === 0 ? <div className="text-center mt-20 text-neutral-600 font-mono">VACO</div> : cart.map((item, i) => (
                                    <div key={`${item.id}-${item.size}-${i}`} className="flex gap-4 bg-[#0a0a0a] p-3 border border-[#222] relative group">
                                        <img src={item.image} className="w-20 h-24 object-cover grayscale"/>
                                        <div className="flex flex-col justify-between py-1">
                                            <div><h4 className="font-bold text-white text-sm line-clamp-1">{item.name}</h4><p className="text-[9px] text-neutral-500">TALLA {item.size} / x{item.qty}</p></div>
                                            <span className="text-[#ccff00] font-mono font-bold">C$ {formatPrice(item.price)}</span>
                                        </div>
                                        <button onClick={() => remove(i)} className="absolute top-2 right-2 text-neutral-500 hover:text-[#ff003c] z-10 p-2"><Icon name="trash-2" size={16}/></button>
                                    </div>
                                ))}
                            </div>
                            {cart.length > 0 && (
                                <div className="p-6 border-t border-[#222] bg-[#0a0a0a]">
                                    <div className="flex justify-between items-end mb-6 font-mono"><span className="text-neutral-500 text-sm">TOTAL</span><span className="text-2xl font-bold text-white">C$ {formatPrice(total)}</span></div>
                                    <Button className="w-full" onClick={onCheckout}>PAGAR AHORA</Button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <CriticalErrorBanner error={criticalError} onClose={() => setCriticalError(null)} />
                    <Marquee />
                    <Toast show={toast.show} message={toast.msg} />
                    
                    <nav className="sticky top-0 z-50 bg-[#050505]/90 backdrop-blur-md border-b border-[#222] h-20 px-6 flex items-center justify-between">
                        <div className="flex items-center gap-2 cursor-pointer group" onClick={() => setView('home')}>
                            <span className="font-logo font-bold text-2xl tracking-tighter text-white group-hover:text-[#ff003c] transition-colors">KURA STUDIO</span>
                            <span className="jp-dynamic">┿广裤搞</span>
                        </div>
                        
                        <div className="flex items-center gap-6">
                            <button className="relative group" onClick={() => setIsCartOpen(true)}>
                                <Icon name="shopping-bag" className="text-white group-hover:text-[#ff003c] transition-colors"/>
                                {cart.length > 0 && <span className="absolute -top-2 -right-2 bg-[#ccff00] text-black text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-sm">{cart.length}</span>}
                            </button>
                        </div>
                    </nav>

                    <main className="flex-1">
                        {view === 'home' && (
                            <>
                                <Hero products={products} />
                                <div id="shop" className="container mx-auto px-6 py-24">
                                    <div className="flex justify-between items-end mb-12 border-b border-[#222] pb-4">
                                        <h2 className="text-4xl font-black font-logo text-white uppercase">CATLOGO</h2>
                                        <span className="font-mono text-[#ff003c] text-xs font-bold">{products.length} ITEMS</span>
                                    </div>
                                    <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-8">
                                        {products.map(product => {
                                            const hasDiscount = product.comparePrice && product.comparePrice > product.price;
                                            return (
                                                <div key={product.id} className="group cursor-pointer" onClick={() => { setSelectedProduct(product); setView('product'); }}>
                                                    <div className="aspect-[3/4] overflow-hidden bg-[#0a0a0a] border border-[#222] relative mb-4">
                                                        <img src={product.image} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 group-hover:scale-110 transition-all duration-700"/>
                                                        {hasDiscount ? (
                                                            <div className="absolute top-2 left-0 bg-[#ccff00] text-black text-[9px] font-bold px-2 py-1 uppercase tracking-widest translate-x-[-100%] group-hover:translate-x-0 transition-transform">OFERTA</div>
                                                        ) : (
                                                            <div className="absolute top-2 left-0 bg-[#ff003c] text-white text-[9px] font-bold px-2 py-1 uppercase tracking-widest translate-x-[-100%] group-hover:translate-x-0 transition-transform">NEW</div>
                                                        )}
                                                    </div>
                                                    <div className="px-2">
                                                        <p className="text-[10px] text-neutral-500 font-bold uppercase tracking-widest mb-1">{product.category}</p>
                                                        <h3 className="text-sm font-bold text-white uppercase truncate mb-2">{product.name}</h3>
                                                        <div className="flex items-center gap-2">
                                                            <span className="font-mono text-lg font-bold text-[#ff003c]">C$ {formatPrice(product.price)}</span>
                                                            {hasDiscount && <span className="font-mono text-xs text-neutral-500 line-through">C$ {formatPrice(product.comparePrice)}</span>}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </>
                        )}

                        {view === 'product' && selectedProduct && (
                            <ProductDetail product={selectedProduct} onBack={() => setView('home')} onAdd={addToCart} />
                        )}

                        {view === 'checkout' && (
                            <SmartCheckout 
                                cart={cart} 
                                subtotal={cartTotal} 
                                onBack={() => setView('home')} 
                                setCriticalError={setCriticalError}
                                setPersistentOrder={setPersistentOrder}
                                setView={setView} 
                            />
                        )}
                        
                        {/* Nuevo: Vista de Confirmaci贸n Persistente */}
                        {view === 'confirmation' && persistentOrder && (
                            <OrderConfirmationScreen 
                                orderData={persistentOrder} 
                                onConfirmFinish={clearPersistentOrder} 
                                setCriticalError={setCriticalError}
                            />
                        )}
                    </main>

                    <footer className="bg-[#0a0a0a] border-t border-[#222] py-12">
                        <div className="container mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-6">
                            <span className="font-logo font-bold text-2xl text-[#333]">KURA STUDIO</span>
                            <p className="text-neutral-600 text-[10px] font-mono uppercase tracking-widest">漏 2026 KURA STUDIO. ALL RIGHTS RESERVED.</p>
                        </div>
                    </footer>

                    <CartDrawer 
                        isOpen={isCartOpen} 
                        onClose={() => setIsCartOpen(false)} 
                        cart={cart}
                        remove={removeFromCart}
                        clearCart={clearCart}
                        onCheckout={() => { setIsCartOpen(false); setView('checkout'); }}
                    />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
    </html>
